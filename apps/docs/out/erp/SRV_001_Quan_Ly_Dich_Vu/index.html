<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T5832,"])</script><script>self.__next_f.push([1,"# SRV_001_Service_Quản Lý Dịch Vụ\n\n*Phiên bản: 1.0*\n*Người tạo: Gemini AI Assistant*\n*Ngày tạo: 2024-07-31*\n*Cập nhật lần cuối: 2024-07-31*\n*Người cập nhật: Gemini AI Assistant*\n\n## 1. Tổng Quan Nghiệp Vụ\n\n### 1.1. Mô Tả Nghiệp Vụ\nNghiệp vụ Quản Lý Dịch Vụ (trong mã nguồn là `DichVuModel`) cho phép người dùng định nghĩa và quản lý các dịch vụ trong hệ thống. Mỗi dịch vụ bao gồm các thông tin như mã, tên, đơn vị tính, tài khoản doanh thu, tài khoản chi phí, mã thuế, giá và các thông tin liên quan khác. Mục đích là cung cấp một danh mục chuẩn hóa các dịch vụ để sử dụng trong các quy trình nghiệp vụ khác như lập hóa đơn, tính giá, ghi nhận doanh thu, và báo cáo.\n\n### 1.2. Phạm Vi Áp Dụng\n- Áp dụng cho từng Đơn vị (Entity) trong hệ thống.\n- Các bộ phận liên quan đến quản lý dịch vụ, kế toán, bán hàng, và báo cáo.\n\n### 1.3. Định Nghĩa Thuật Ngữ\n| Thuật ngữ | Định nghĩa |\n|-----------|------------|\n| Dịch Vụ | Một sản phẩm không hữu hình được cung cấp cho khách hàng. Trong mã nguồn là `DichVuModel`. |\n| Đơn vị (Entity) | Tổ chức hoặc công ty mà dịch vụ được định nghĩa và áp dụng. |\n| `ma_dv` | Mã định danh duy nhất cho một dịch vụ trong một đơn vị. |\n| `ten_dv` | Tên chính của dịch vụ. |\n| `ten_dv2` | Tên thay thế/phụ của dịch vụ. |\n| `action` | Hành động liên quan đến dịch vụ. |\n| `param` | Tham số tùy chọn cho dịch vụ. |\n| `dvt` | Đơn vị tính của dịch vụ (liên kết đến `DonViTinhModel`). |\n| `tk_dt` | Tài khoản doanh thu liên quan đến dịch vụ (liên kết đến `AccountModel`). |\n| `tk_cp` | Tài khoản chi phí liên quan đến dịch vụ (liên kết đến `AccountModel`). |\n| `ma_thue` | Mã thuế liên quan đến dịch vụ (liên kết đến `TaxModel`). |\n| `gia_nt` | Giá ngoại tệ chính của dịch vụ. |\n| `gia_nt2` | Giá ngoại tệ thứ hai của dịch vụ. |\n| `status` | Trạng thái của dịch vụ: 1 (Active - Hoạt động), 0 (Inactive - Không hoạt động). |\n\n### 1.4. Tài Liệu Liên Quan\n| STT | Mã tài liệu | Tên tài liệu | Mô tả |\n|-----|-------------|--------------|-------|\n| 1   | `django_ledger/models/dich_vu.py` | Model Định Nghĩa Dịch Vụ | Định nghĩa cấu trúc dữ liệu cho `DichVuModel`. |\n| 2   | `django_ledger/api/views/dich_vu.py` | API Endpoints Dịch Vụ | Các điểm cuối API để tương tác với nghiệp vụ Quản Lý Dịch Vụ. |\n| 3   | `django_ledger/api/serializers/dich_vu.py` | Serializers Dịch Vụ | Định dạng dữ liệu JSON cho API, thực hiện validation. |\n| 4   | `django_ledger/services/dich_vu/service.py` | Service Logic Dịch Vụ | Logic nghiệp vụ cho việc tạo, cập nhật, xóa, truy vấn Dịch Vụ. |\n| 5   | `django_ledger/repositories/dich_vu/repository.py` | Repository Dịch Vụ | Lớp truy cập dữ liệu cho Dịch Vụ. |\n| 6   | `django_ledger/api/urls.py` | URL Configuration | Đăng ký endpoint `/api/{entity_slug}/services/` cho Dịch Vụ. |\n\n## 2. Quy Trình Nghiệp Vụ\n\n### 2.1. Tổng Quan Quy Trình\nNgười dùng có thẩm quyền (ví dụ: quản trị viên, quản lý) tương tác với hệ thống thông qua giao diện người dùng hoặc API để thực hiện các thao tác CRUD (Create, Read, Update, Delete) đối với các Dịch Vụ. Hệ thống sẽ xử lý các yêu cầu này thông qua `DichVuViewSet`, sử dụng `DichVuService` để thực thi logic nghiệp vụ và `DichVuRepository` để tương tác với cơ sở dữ liệu. Dữ liệu đầu vào sẽ được kiểm tra (validate) bởi `DichVuModelSerializer` và `DichVuService`.\n\n### 2.2. Sơ Đồ Quy Trình (Business Flow)\n\n```mermaid\nflowchart TD\n    A[Người dùng yêu cầu thao tác Dịch Vụ] --\u003e B{API Gateway nhận yêu cầu};\n    B --\u003e C[Xác thực \u0026 Ủy quyền (IsAuthenticated)];\n    C --\u003e D[DichVuViewSet];\n    D --\u003e E[DichVuService];\n    E --\u003e F[DichVuRepository];\n    F --\u003e G[(Cơ sở dữ liệu - Bảng dich_vu)];\n    G --\u003e F;\n    F --\u003e E;\n    E --\u003e D;\n    subgraph \"Validation\"\n        direction LR\n        H[Request Data] --\u003e I[DichVuModelSerializer];\n        I --\u003e J[DichVuService.validate_fields];\n    end\n    D --\u003e H;\n    J -- Dữ liệu hợp lệ --\u003e E;\n    J -- Dữ liệu không hợp lệ --\u003e K[Báo lỗi cho ViewSet];\n    K --\u003e B;\n    D --\u003e L[Trả kết quả cho người dùng];\n    B --\u003e L;\n```\n\n### 2.3. Chi Tiết Các Bước Quy Trình\n\n#### 2.3.1. Tạo Mới Dịch Vụ\n- **Mô tả**: Người dùng cung cấp thông tin để tạo một Dịch Vụ mới cho một Đơn vị.\n- **Đầu vào**: Dữ liệu Dịch Vụ (`ma_dv`, `ten_dv`, `action`, và các thông tin khác). `entity_slug` được lấy từ URL.\n- **Đầu ra**: Dịch Vụ mới được tạo thành công hoặc thông báo lỗi.\n- **Người thực hiện**: Quản trị viên, quản lý.\n- **Điều kiện tiên quyết**: Đăng nhập hệ thống, có quyền truy cập vào Đơn vị. `ma_dv` phải là duy nhất trong Đơn vị đó. `ma_dv`, `ten_dv`, và `action` là bắt buộc.\n- **Xử lý ngoại lệ**: Dữ liệu không hợp lệ (thiếu trường, sai định dạng, `ma_dv` bị trùng), Đơn vị không tồn tại.\n\n#### 2.3.2. Xem/Tìm Kiếm Dịch Vụ\n- **Mô tả**: Người dùng xem danh sách các Dịch Vụ của một Đơn vị hoặc chi tiết một Dịch Vụ cụ thể. Hỗ trợ phân trang và lọc theo trạng thái.\n- **Đầu vào**: `entity_slug` (từ URL). Tùy chọn: `uuid` của Dịch Vụ (để xem chi tiết), tham số phân trang (`page`, `page_size`).\n- **Đầu ra**: Danh sách các Dịch Vụ hoặc thông tin chi tiết của một Dịch Vụ.\n- **Người thực hiện**: Mọi người dùng có quyền xem.\n- **Điều kiện tiên quyết**: Đăng nhập hệ thống.\n- **Xử lý ngoại lệ**: Dịch Vụ không tồn tại, Đơn vị không tồn tại.\n\n#### 2.3.3. Cập Nhật Dịch Vụ\n- **Mô tả**: Người dùng thay đổi thông tin của một Dịch Vụ đã tồn tại.\n- **Đầu vào**: `entity_slug`, `uuid` của Dịch Vụ, và dữ liệu cần cập nhật.\n- **Đầu ra**: Dịch Vụ được cập nhật thành công hoặc thông báo lỗi.\n- **Người thực hiện**: Quản trị viên, quản lý.\n- **Điều kiện tiên quyết**: Đăng nhập, Dịch Vụ phải tồn tại và thuộc Đơn vị chỉ định. Nếu `ma_dv` thay đổi, mã mới không được trùng.\n- **Xử lý ngoại lệ**: Dữ liệu không hợp lệ, Dịch Vụ không tồn tại, `ma_dv` mới bị trùng.\n\n#### 2.3.4. Xóa Dịch Vụ\n- **Mô tả**: Người dùng xóa một Dịch Vụ khỏi hệ thống.\n- **Đầu vào**: `entity_slug`, `uuid` của Dịch Vụ.\n- **Đầu ra**: Thông báo xóa thành công hoặc thông báo lỗi.\n- **Người thực hiện**: Quản trị viên, quản lý.\n- **Điều kiện tiên quyết**: Đăng nhập, Dịch Vụ phải tồn tại và thuộc Đơn vị chỉ định. (Cần xem xét ràng buộc nếu Dịch Vụ đang được sử dụng ở nơi khác).\n- **Xử lý ngoại lệ**: Dịch Vụ không tồn tại, Dịch Vụ đang được sử dụng.\n\n### 2.4. Sơ Đồ Tuần Tự (Sequence Diagram) - Tạo mới Dịch Vụ\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant APIView as DichVuViewSet\n    participant Service as DichVuService\n    participant Serializer as DichVuModelSerializer\n    participant Repository as DichVuRepository\n    participant Model as DichVuModel\n    participant DB as Database\n\n    User-\u003e\u003eAPIView: POST /api/{entity_slug}/services/ (data)\n    APIView-\u003e\u003eSerializer: validate(data)\n    Serializer--\u003e\u003eAPIView: validated_data\n    APIView-\u003e\u003eService: get_service()\n    Service--\u003e\u003eAPIView: service_instance\n    APIView-\u003e\u003eService: create(**validated_data)\n    Service-\u003e\u003eService: validate_fields(**validated_data)\n    Service-\u003e\u003eService: get_entity_model()\n    Service--\u003e\u003eService: entity_model\n    Service-\u003e\u003eRepository: exist_by_ma_dv(entity_model, ma_dv)\n    Repository--\u003e\u003eService: exists (boolean)\n    \n    alt ma_dv already exists\n        Service--\u003e\u003eAPIView: Raise ValidationError\n        APIView--\u003e\u003eUser: HTTP 400 (Error details)\n    else ma_dv is unique\n        Service-\u003e\u003eModel: objects.create(entity_model=entity_model, **validated_data)\n        Model-\u003e\u003eDB: INSERT INTO dich_vu\n        DB--\u003e\u003eModel: created_instance\n        Model--\u003e\u003eService: created_instance\n        Service--\u003e\u003eAPIView: created_instance\n        APIView--\u003e\u003eUser: HTTP 201 (serialized_data)\n    end\n```\n\n### 2.5. Luồng Nghiệp Vụ Thay Thế\n- **Lấy hoặc tạo**: Khi cần một Dịch Vụ, hệ thống có thể sử dụng phương thức `get_or_create` để lấy một Dịch Vụ hiện có hoặc tạo một Dịch Vụ mới nếu không tồn tại.\n- **Cập nhật hoặc tạo**: Hệ thống cũng cung cấp phương thức `update_or_create` để cập nhật một Dịch Vụ hiện có hoặc tạo một Dịch Vụ mới nếu không tồn tại.\n- **Lọc theo trạng thái**: Người dùng có thể lọc Dịch Vụ theo trạng thái (hoạt động/không hoạt động) để dễ dàng quản lý.\n\n## 3. Yêu Cầu Chức Năng\n\n### 3.1. Danh Sách Chức Năng\n\n| STT | Mã chức năng | Tên chức năng | Mô tả | Độ ưu tiên |\n|-----|--------------|---------------|-------|------------|\n| 1   | SRV001-LIST | Xem danh sách Dịch Vụ | Lấy danh sách Dịch Vụ theo Đơn vị, hỗ trợ phân trang. | Cao |\n| 2   | SRV001-CREATE | Tạo mới Dịch Vụ | Tạo một Dịch Vụ mới cho một Đơn vị. | Cao |\n| 3   | SRV001-RETRIEVE | Xem chi tiết Dịch Vụ | Lấy thông tin chi tiết của một Dịch Vụ bằng UUID. | Cao |\n| 4   | SRV001-UPDATE | Cập nhật Dịch Vụ | Cập nhật thông tin của một Dịch Vụ đã có (PUT). | Cao |\n| 5   | SRV001-PARTIAL-UPDATE | Cập nhật một phần Dịch Vụ | Cập nhật một phần thông tin của một Dịch Vụ đã có (PATCH). | Trung bình |\n| 6   | SRV001-DELETE | Xóa Dịch Vụ | Xóa một Dịch Vụ. | Cao |\n| 7   | SRV001-FILTER | Lọc Dịch Vụ | Lọc danh sách Dịch Vụ theo các tiêu chí. | Trung bình |\n| 8   | SRV001-COUNT | Đếm số lượng Dịch Vụ | Đếm số lượng Dịch Vụ theo Đơn vị và các tiêu chí lọc. | Thấp |\n\n### 3.2. Chi Tiết Chức Năng\n\n#### 3.2.1. SRV001-CREATE: Tạo mới Dịch Vụ\n- **Mô tả**: Cho phép tạo một Dịch Vụ mới.\n- **Đầu vào**: `entity_slug` (trong URL). Dữ liệu JSON body: `ma_dv` (string, bắt buộc), `ten_dv` (string, bắt buộc), `action` (string, bắt buộc), `ten_dv2` (string, tùy chọn), `status` (int, tùy chọn, default 1), và các trường khác.\n- **Đầu ra**: Dữ liệu JSON của Dịch Vụ vừa tạo.\n- **Điều kiện tiên quyết**: `ma_dv`, `ten_dv`, `action` phải được cung cấp. `ma_dv` phải là duy nhất cho `entity_model`.\n- **Luồng xử lý chính**:\n  1. `DichVuViewSet.perform_create()` nhận dữ liệu đã được validate bởi serializer.\n  2. Lấy `service` instance.\n  3. Gọi `service.create(**serializer.validated_data)`.\n     a. Service validate các trường: `ma_dv`, `ten_dv`, `action` bắt buộc.\n     b. Service lấy `entity_model` từ `entity_slug`.\n     c. Service kiểm tra xem `ma_dv` đã tồn tại chưa.\n     d. Service tạo bản ghi `DichVuModel` trong DB.\n  4. ViewSet trả về HTTP 201 với dữ liệu Dịch Vụ đã tạo.\n- **Luồng xử lý thay thế/ngoại lệ**:\n  - Validation thất bại (Serializer hoặc Service): Trả về HTTP 400 với chi tiết lỗi.\n  - `entity_slug` không hợp lệ: Service sẽ raise ValidationError.\n  - `ma_dv` bị trùng: Service sẽ raise ValidationError.\n- **Giao diện liên quan**: Form tạo mới Dịch Vụ.\n\n## 4. Thiết Kế Kỹ Thuật\n\n### 4.1. Kiến Trúc Hệ Thống\nNghiệp vụ này tuân theo kiến trúc 3 lớp với sự hỗ trợ của Repository pattern:\n- **View (API Layer)**: `DichVuViewSet` xử lý HTTP request/response, xác thực, phân trang, và gọi các services.\n- **Service Layer**: `DichVuService` chứa logic nghiệp vụ chính, điều phối hoạt động giữa View và Repository, thực hiện validation nghiệp vụ.\n- **Repository Layer**: `DichVuRepository` chịu trách nhiệm tương tác trực tiếp với cơ sở dữ liệu thông qua Django ORM (`DichVuModel`).\n- **Model Layer**: `DichVuModel` định nghĩa cấu trúc dữ liệu, bao gồm các trường, ràng buộc và custom manager/queryset.\n\n```mermaid\ngraph TD\n    Client --\u003e Nginx --\u003e Gunicorn\n    Gunicorn --\u003e DjangoApp[Django Application]\n\n    subgraph DjangoApp\n        APILayer[API Layer: DichVuViewSet]\n        ServiceLayer[Service Layer: DichVuService]\n        RepositoryLayer[Repository Layer: DichVuRepository]\n        ModelLayer[Model Layer: DichVuModel]\n        Database[(PostgreSQL Database - dich_vu table)]\n\n        APILayer --\u003e|calls| ServiceLayer\n        ServiceLayer --\u003e|uses| RepositoryLayer\n        RepositoryLayer --\u003e|accesses| ModelLayer\n        ModelLayer --\u003e|maps to| Database\n    end\n```\n\n### 4.2. API Endpoints\n\n#### 4.2.1. Dịch Vụ (`DichVuModel`)\n- **Mô tả**: Quản lý các dịch vụ.\n- **Base URL**: `/api/{entity_slug}/services/`\n- **Endpoints**:\n  - `GET /`: Lấy danh sách Dịch Vụ (hỗ trợ phân trang `ERPPagination`).\n    - Query params: `page`, `page_size`.\n  - `POST /`: Tạo một Dịch Vụ mới.\n  - `GET /{uuid}/`: Lấy chi tiết một Dịch Vụ.\n  - `PUT /{uuid}/`: Cập nhật toàn bộ một Dịch Vụ.\n  - `PATCH /{uuid}/`: Cập nhật một phần một Dịch Vụ.\n  - `DELETE /{uuid}/`: Xóa một Dịch Vụ.\n\n### 4.3. Service Logic (`DichVuService`)\n- **Mô tả**: Cung cấp logic nghiệp vụ cho `DichVuModel`.\n- **Chức năng chính**:\n  1. `validate_fields(**kwargs)`: Kiểm tra các trường bắt buộc (`ma_dv`, `ten_dv`, `action`).\n  2. `get_entity_model()`: Lấy `EntityModel` từ slug.\n  3. `create(**kwargs)`: Tạo một Dịch Vụ mới.\n  4. `update(instance, **kwargs)`: Cập nhật một Dịch Vụ hiện có.\n  5. `delete(instance)`: Xóa một Dịch Vụ.\n  6. `get(raise_404=False, **kwargs)`: Lấy một Dịch Vụ cụ thể.\n  7. `filter(page=None, page_size=None, **kwargs)`: Lọc Dịch Vụ theo các tiêu chí, có phân trang.\n  8. `all(page=None, page_size=None)`: Lấy tất cả Dịch Vụ, có phân trang.\n  9. `count()`: Đếm số lượng Dịch Vụ.\n  10. `exists(**kwargs)`: Kiểm tra một Dịch Vụ có tồn tại không.\n  11. `get_or_create(defaults=None, **kwargs)`: Lấy hoặc tạo một Dịch Vụ.\n  12. `update_or_create(defaults=None, **kwargs)`: Cập nhật hoặc tạo một Dịch Vụ.\n- **Các dependencies**: `DichVuRepository`, `EntityModel`.\n\n### 4.4. Mô Hình Dữ Liệu\n\n#### 4.4.1. Entity Relationship Diagram (ERD)\n\n```mermaid\nerDiagram\n    EntityModel ||--o{ DichVuModel : \"has\"\n    DichVuModel }o--o{ AccountModel : \"has revenue/cost accounts\"\n    DichVuModel }o--o| DonViTinhModel : \"has unit\"\n    DichVuModel }o--o| TaxModel : \"has tax\"\n    DichVuModel }o--o| ChiPhiModel : \"has cost\"\n    DichVuModel }o--o| PhiModel : \"has fee\"\n    DichVuModel }o--o| BoPhanModel : \"belongs to department\"\n    DichVuModel }o--o| ContractModel : \"associated with contract\"\n    DichVuModel }o--o| KheUocModel : \"associated with agreement\"\n    DichVuModel }o--o| VuViecModel : \"associated with case\"\n\n    EntityModel {\n        UUID uuid PK\n        string slug\n        string name\n        # ... other fields\n    }\n\n    DichVuModel {\n        UUID uuid PK\n        UUID entity_model_id FK\n        string ma_dv \"Service code\"\n        string ten_dv \"Service name\"\n        string ten_dv2 \"Alternative service name\"\n        string action \"Service action\"\n        string param \"Optional parameter\"\n        UUID dvt_id FK \"Unit of measurement\"\n        UUID tk_dt_id FK \"Revenue account\"\n        UUID tk_cp_id FK \"Cost account\"\n        UUID ma_thue_id FK \"Tax code\"\n        float gia_nt \"Foreign currency price\"\n        float gia_nt2 \"Foreign currency price 2\"\n        UUID ma_cp_id FK \"Cost code\"\n        UUID ma_phi_id FK \"Fee code\"\n        UUID ma_bp_id FK \"Department code\"\n        UUID ma_hd_id FK \"Contract code\"\n        UUID ma_ku_id FK \"Agreement code\"\n        UUID ma_vv_id FK \"Case code\"\n        int status \"Status (1=active, 0=inactive)\"\n        datetime created\n        datetime updated\n    }\n```\n\n#### 4.4.2. Chi Tiết Bảng Dữ Liệu\n\n##### Bảng: `dich_vu` (mapped from `DichVuModel`)\n- **Mô tả**: Lưu trữ thông tin các dịch vụ.\n- **Các cột chính**:\n  - `uuid` (PK, UUIDField): Định danh duy nhất.\n  - `entity_model_id` (FK, UUIDField): Liên kết đến bảng `entity`.\n  - `ma_dv` (CharField): Mã dịch vụ.\n  - `ten_dv` (CharField): Tên dịch vụ.\n  - `ten_dv2` (CharField): Tên thay thế của dịch vụ.\n  - `action` (CharField): Hành động liên quan đến dịch vụ.\n  - `param` (CharField, nullable): Tham số tùy chọn cho dịch vụ.\n  - `dvt_id` (FK, UUIDField, nullable): Liên kết đến bảng `don_vi_tinh`.\n  - `tk_dt_id` (FK, UUIDField, nullable): Liên kết đến bảng `account` (tài khoản doanh thu).\n  - `tk_cp_id` (FK, UUIDField, nullable): Liên kết đến bảng `account` (tài khoản chi phí).\n  - `ma_thue_id` (FK, UUIDField, nullable): Liên kết đến bảng `tax`.\n  - `gia_nt` (FloatField): Giá ngoại tệ chính.\n  - `gia_nt2` (FloatField): Giá ngoại tệ thứ hai.\n  - `ma_cp_id` (FK, UUIDField, nullable): Liên kết đến bảng `chi_phi`.\n  - `ma_phi_id` (FK, UUIDField, nullable): Liên kết đến bảng `phi`.\n  - `ma_bp_id` (FK, UUIDField, nullable): Liên kết đến bảng `bo_phan`.\n  - `ma_hd_id` (FK, UUIDField, nullable): Liên kết đến bảng `contract`.\n  - `ma_ku_id` (FK, UUIDField, nullable): Liên kết đến bảng `khe_uoc`.\n  - `ma_vv_id` (FK, UUIDField, nullable): Liên kết đến bảng `vu_viec`.\n  - `status` (IntegerField, default 1): Trạng thái (1=hoạt động, 0=không hoạt động).\n  - `created` (DateTimeField): Thời điểm tạo.\n  - `updated` (DateTimeField): Thời điểm cập nhật cuối.\n- **Indexes**: (`entity_model`, `ma_dv`), (`status`), (`created`), (`updated`).\n\n## 5. Kế Hoạch Kiểm Thử\n\n### 5.1. Phạm Vi Kiểm Thử\n- Kiểm thử các chức năng CRUD cho Dịch Vụ qua API endpoints.\n- Kiểm thử validation dữ liệu đầu vào (trường bắt buộc, tính duy nhất của `ma_dv`).\n- Kiểm thử logic phân quyền (người dùng chỉ thao tác được Dịch Vụ của Entity mình có quyền).\n- Kiểm thử các phương thức đặc biệt như `get_or_create`, `update_or_create`.\n- Kiểm thử API endpoints (status codes, response format, pagination).\n\n### 5.2. Kịch Bản Kiểm Thử\n| STT | Mã kịch bản | Tên kịch bản | Mô tả | Điều kiện tiên quyết | Các bước | Kết quả mong đợi |\n|-----|------------|--------------|-------|---------------------|----------|-----------------|\n| 1   | TC_SRV001_001 | Tạo Dịch Vụ thành công | Kiểm tra tạo mới Dịch Vụ với dữ liệu hợp lệ. | User đăng nhập, có quyền. `entity_slug` hợp lệ. | 1. Gửi POST request tới `/api/{entity_slug}/services/` với data hợp lệ (`ma_dv`, `ten_dv`, `action`). | 1. Response status 201. 2. Response body chứa thông tin Dịch Vụ đã tạo. 3. Dữ liệu được lưu đúng trong DB. |\n| 2   | TC_SRV001_002 | Tạo Dịch Vụ thất bại - `ma_dv` trùng | Kiểm tra không cho tạo Dịch Vụ nếu `ma_dv` đã tồn tại cho entity. | User đăng nhập. `ma_dv` đã tồn tại cho entity. | 1. Gửi POST request với `ma_dv` đã có. | 1. Response status 400. 2. Thông báo lỗi về `ma_dv` bị trùng. |\n| 3   | TC_SRV001_003 | Tạo Dịch Vụ thất bại - thiếu trường bắt buộc | Kiểm tra lỗi khi thiếu trường bắt buộc. | User đăng nhập. | 1. Gửi POST request thiếu một trong các trường: `ma_dv`, `ten_dv`, `action`. | 1. Response status 400. 2. Thông báo lỗi trường bắt buộc. |\n| 4   | TC_SRV001_004 | Lấy danh sách Dịch Vụ | Kiểm tra lấy danh sách Dịch Vụ, có phân trang. | Có sẵn vài Dịch Vụ. | 1. Gửi GET request tới `/api/{entity_slug}/services/?page=1\u0026page_size=2`. | 1. Response status 200. 2. Response body chứa danh sách Dịch Vụ (tối đa 2), thông tin phân trang. |\n| 5   | TC_SRV001_005 | Cập nhật Dịch Vụ | Kiểm tra cập nhật thông tin Dịch Vụ. | Dịch Vụ tồn tại. | 1. Gửi PUT request tới `/api/{entity_slug}/services/{uuid}/` với data mới. | 1. Response status 200. 2. Dữ liệu Dịch Vụ được cập nhật trong DB. |\n| 6   | TC_SRV001_006 | Xóa Dịch Vụ | Kiểm tra xóa Dịch Vụ. | Dịch Vụ tồn tại. | 1. Gửi DELETE request tới `/api/{entity_slug}/services/{uuid}/`. | 1. Response status 204. 2. Dịch Vụ bị xóa khỏi DB. |\n| 7   | TC_SRV001_007 | Kiểm tra get_or_create | Kiểm tra lấy Dịch Vụ nếu tồn tại hoặc tạo mới nếu không. | Environment sẵn sàng. | 1. Gọi phương thức `get_or_create` với `ma_dv` đã tồn tại. 2. Gọi lại với `ma_dv` chưa tồn tại. | 1. Lần 1: Trả về instance hiện có và `created=False`. 2. Lần 2: Trả về instance mới và `created=True`. |\n\n## 6. Phụ Lục\n\n### 6.1. Danh Sách Tài Liệu Tham Khảo\n- Mã nguồn dự án ERP-BE (các file đã liệt kê ở mục 1.4).\n- Tài liệu Django REST framework.\n- Tài liệu drf-spectacular (cho schema generation).\n\n### 6.2. Danh Mục Thuật Ngữ\n(Xem mục 1.3)\n\n### 6.3. Lịch Sử Thay Đổi Tài Liệu\n| Phiên bản | Ngày       | Người thực hiện      | Mô tả thay đổi                         |\n|-----------|------------|----------------------|----------------------------------------|\n| 1.0       | 2024-07-31 | Gemini AI Assistant  | Tạo tài liệu ban đầu dựa trên source code. | "])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/SRV_001_Quan_Ly_Dich_Vu\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/SRV_001_Quan_Ly_Dich_Vu/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/SRV_001_Quan_Ly_Dich_Vu\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"SRV_001_Quan_Ly_Dich_Vu\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/SRV_001_Quan_Ly_Dich_Vu\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>