<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T58b0,"])</script><script>self.__next_f.push([1,"# SAL_003_Quản Lý Giá Bán\n\n*Phiên bản: 1.0*  \n*Người tạo: ChatGPT*  \n*Ngày tạo: 13/05/2025*  \n*Cập nhật lần cuối: 13/05/2025*  \n*Người cập nhật: ChatGPT*\n\n## 1. Tổng Quan Nghiệp Vụ\n\n### 1.1. Mô Tả Nghiệp Vụ\nQuy trình Quản Lý Giá Bán là một thành phần cốt lõi trong phân hệ Quản Lý Bán Hàng của hệ thống ERP. Quy trình này cho phép doanh nghiệp thiết lập, quản lý và áp dụng các chính sách giá bán đa dạng cho sản phẩm và dịch vụ. Bao gồm việc định nghĩa các loại giá bán khác nhau (ví dụ: giá bán lẻ, giá bán sỉ, giá khuyến mãi), tạo bảng giá chi tiết cho từng mặt hàng, quản lý giá theo khách hàng hoặc nhóm khách hàng, thiết lập giá theo số lượng (tiered pricing), và theo dõi lịch sử thay đổi giá.\n\n### 1.2. Phạm Vi Áp Dụng\n- **Phòng Kinh Doanh**: Thiết lập chính sách giá, tạo và cập nhật bảng giá, áp dụng giá cho đơn hàng.\n- **Phòng Marketing**: Đề xuất và quản lý các chương trình giá khuyến mãi.\n- **Phòng Kế Toán**: Đối soát giá trên hóa đơn, phân tích hiệu quả giá.\n- **Ban Lãnh Đạo**: Phê duyệt chính sách giá, theo dõi báo cáo doanh thu theo giá.\n\n### 1.3. Định Nghĩa Thuật Ngữ\n| Thuật ngữ | Định nghĩa |\n|-----------|------------|\n| Loại giá bán (Sales Price Type) | Phân loại các bảng giá khác nhau (ví dụ: giá bán lẻ, giá bán sỉ, giá đại lý cấp 1). Mã: `ma_loai_gb`. |\n| Bảng giá (Price List / Sales Price) | Danh sách giá bán cụ thể cho từng mặt hàng, có thể áp dụng cho một loại giá bán, khách hàng, hoặc có hiệu lực trong một khoảng thời gian nhất định. Mã: `GiaBanModel`. |\n| Giá bán chi tiết (Tiered Pricing / Sales Price Detail) | Cấu trúc giá bán theo từng khoảng số lượng mua, cho phép áp dụng các mức giá hoặc chiết khấu khác nhau tùy theo số lượng. Mã: `GiaBanChiTietModel`. |\n| Ngày hiệu lực | Ngày bắt đầu có hiệu lực của một bảng giá hoặc một mức giá cụ thể. |\n| Đơn vị tính (ĐVT) | Đơn vị của sản phẩm được áp dụng giá (ví dụ: Cái, Hộp, Kg). |\n| Ngoại tệ | Đơn vị tiền tệ của giá bán (ví dụ: VND, USD). |\n\n### 1.4. Tài Liệu Liên Quan\n| STT | Mã tài liệu | Tên tài liệu | Mô tả |\n|-----|-------------|--------------|-------|\n| 1   | SAL_001 | Quản Lý Khách Hàng | Thông tin khách hàng để áp dụng giá đặc biệt. |\n| 2   | SAL_002 | Quản Lý Nhóm Khách Hàng | Phân nhóm khách hàng để áp dụng chính sách giá theo nhóm. |\n| 3   | SAL_004 | Quản Lý Hóa Đơn Bán Hàng | Áp dụng giá bán vào hóa đơn. |\n| 4   | INV_002 | Quản Lý Vật Tư Sản Phẩm | Thông tin mặt hàng để thiết lập giá. |\n| 5   | ACC_007 | Quản Lý Tỷ Giá | Quản lý tỷ giá khi giá bán bằng ngoại tệ. |\n\n## 2. Quy Trình Nghiệp Vụ\n\n### 2.1. Tổng Quan Quy Trình\nQuy trình Quản Lý Giá Bán bao gồm các giai đoạn chính:\n1.  Thiết lập các loại giá bán.\n2.  Tạo và quản lý bảng giá cho từng mặt hàng, có thể theo loại giá, khách hàng, ngày hiệu lực.\n3.  Thiết lập giá bán chi tiết theo số lượng (tiered pricing).\n4.  Áp dụng giá bán vào các giao dịch bán hàng.\n5.  Theo dõi và báo cáo về giá bán.\n\n### 2.2. Sơ Đồ Quy Trình (Business Flow)\n\n```mermaid\nflowchart TD\n    A[Bắt đầu] --\u003e B[Thiết lập Loại Giá Bán (ma_loai_gb)]\n    B --\u003e C[Tạo Bảng Giá (GiaBanModel)]\n    C --\u003e D[Nhập thông tin: Mặt hàng, ĐVT, Ngày hiệu lực, Tiền tệ, Giá cơ bản]\n    D --\u003e E{Giá theo khách hàng/nhóm KH?}\n    E --Có--\u003e F[Chọn Khách hàng/Nhóm KH]\n    F --\u003e G\n    E --Không--\u003e G{Giá theo số lượng (Tiered Pricing)?}\n    G --Có--\u003e H[Tạo Giá Bán Chi Tiết (GiaBanChiTietModel)]\n    H --\u003e I[Nhập: Khoảng số lượng, Giá/Chiết khấu tương ứng]\n    I --\u003e J[Lưu Bảng Giá và Chi Tiết Giá]\n    G --Không--\u003e J\n    J --\u003e K[Áp dụng vào Đơn hàng/Hóa đơn]\n    K --\u003e L[Kết thúc]\n```\n\n### 2.3. Chi Tiết Các Bước Quy Trình\n\n#### 2.3.1. Thiết Lập Loại Giá Bán\n- **Mô tả**: Định nghĩa các danh mục giá bán khác nhau mà doanh nghiệp sử dụng.\n- **Đầu vào**:\n    - Mã loại giá bán (`ma_loai_gb`)\n    - Tên loại giá bán (`ten_loai_gb`)\n    - Tên thay thế (nếu có) (`ten_loai_gb2`)\n    - Trạng thái\n- **Đầu ra**: Danh mục các loại giá bán được lưu trong hệ thống.\n- **Người thực hiện**: Nhân viên Phòng Kinh Doanh/Quản trị hệ thống.\n- **Điều kiện tiên quyết**: Có quyền quản lý loại giá bán.\n- **Xử lý ngoại lệ**: Kiểm tra trùng mã loại giá bán.\n\n#### 2.3.2. Tạo Bảng Giá (Sales Price)\n- **Mô tả**: Thiết lập giá bán cụ thể cho một mặt hàng.\n- **Đầu vào**:\n    - Mã vật tư (`ma_vt`)\n    - Đơn vị tính (`dvt`)\n    - Ngày hiệu lực (`ngay_hl`)\n    - Mã ngoại tệ (`ma_nt`)\n    - Giá bán (`gia_ban`)\n    - Mã loại giá bán (`ma_loai_gb`) (liên kết đến Loại Giá Bán)\n    - Mã khách hàng (`ma_kh`) (tùy chọn)\n    - Nhóm khách hàng 1, 2, 3 (tùy chọn)\n    - Trạng thái\n- **Đầu ra**: Một mục giá bán được tạo trong bảng giá.\n- **Người thực hiện**: Nhân viên Phòng Kinh Doanh.\n- **Điều kiện tiên quyết**: Đã có thông tin mặt hàng, loại giá bán (nếu áp dụng).\n- **Xử lý ngoại lệ**: Kiểm tra tính hợp lệ của ngày, giá trị giá bán phải dương.\n\n#### 2.3.3. Thiết Lập Giá Bán Chi Tiết (Tiered Pricing)\n- **Mô tả**: Cấu hình các mức giá khác nhau dựa trên số lượng mua của một mặt hàng trong một bảng giá cụ thể.\n- **Đầu vào**:\n    - Liên kết đến Bảng Giá (`gia_ban_id`)\n    - Số lượng từ (`sl_tu`)\n    - Số lượng đến (`sl_den`)\n    - Giá bán cho khoảng số lượng này (`gia_ban`)\n    - Tỷ lệ chiết khấu (nếu có) (`chiet_khau`)\n- **Đầu ra**: Các bậc giá theo số lượng được lưu và liên kết với bảng giá gốc.\n- **Người thực hiện**: Nhân viên Phòng Kinh Doanh.\n- **Điều kiện tiên quyết**: Đã tạo Bảng Giá (Sales Price) tương ứng.\n- **Xử lý ngoại lệ**: Kiểm tra các khoảng số lượng không được trùng lắp, giá trị giá bán phải dương.\n\n### 2.4. Sơ Đồ Tuần Tự (Sequence Diagram)\n\n```mermaid\nsequenceDiagram\n    participant User as Người dùng\n    participant LoaiGiaBan_Service as Dịch vụ Loại Giá Bán\n    participant GiaBan_Service as Dịch vụ Bảng Giá\n    participant Order_Service as Dịch vụ Đơn hàng\n    \n    User-\u003e\u003eLoaiGiaBan_Service: Yêu cầu tạo Loại Giá Bán mới\n    LoaiGiaBan_Service--\u003e\u003eUser: Form nhập thông tin\n    User-\u003e\u003eLoaiGiaBan_Service: Gửi thông tin (Mã, Tên)\n    LoaiGiaBan_Service--\u003e\u003eUser: Xác nhận tạo Loại Giá Bán thành công\n\n    User-\u003e\u003eGiaBan_Service: Yêu cầu tạo Bảng Giá mới\n    GiaBan_Service--\u003e\u003eUser: Form nhập thông tin Bảng Giá\n    User-\u003e\u003eGiaBan_Service: Gửi thông tin (Mặt hàng, ĐVT, Ngày HL, Giá, Loại Giá Bán,...)\n    alt Có giá theo số lượng\n        User-\u003e\u003eGiaBan_Service: Gửi thông tin chi tiết giá (SL từ, SL đến, Giá/CK)\n    end\n    GiaBan_Service-\u003e\u003eGiaBan_Service: Validate dữ liệu\n    GiaBan_Service--\u003e\u003eUser: Xác nhận tạo Bảng Giá thành công\n\n    User-\u003e\u003eOrder_Service: Tạo Đơn hàng mới\n    Order_Service--\u003e\u003eUser: Form nhập Đơn hàng\n    User-\u003e\u003eOrder_Service: Nhập Mặt hàng, Số lượng, Khách hàng\n    Order_Service-\u003e\u003eGiaBan_Service: Truy vấn giá bán phù hợp (theo Mặt hàng, KH, Loại giá, Ngày HL, Số lượng)\n    GiaBan_Service--\u003e\u003eOrder_Service: Trả về giá bán áp dụng\n    Order_Service--\u003e\u003eUser: Hiển thị giá và thành tiền trên Đơn hàng\n```\n\n### 2.5. Luồng Nghiệp Vụ Thay Thế\n1.  **Cập nhật giá bán**:\n    *   Thay đổi thông tin trên bảng giá hiện có (ví dụ: giá, ngày hiệu lực).\n    *   Hệ thống cần ghi nhận lịch sử thay đổi giá (nếu có yêu cầu).\n    *   Cân nhắc việc cập nhật này ảnh hưởng đến các đơn hàng chưa xuất hóa đơn như thế nào.\n2.  **Ngừng áp dụng bảng giá**:\n    *   Chuyển trạng thái của bảng giá thành \"Không hoạt động\" hoặc thiết lập ngày hết hiệu lực.\n    *   Bảng giá này sẽ không được áp dụng cho các giao dịch mới.\n3.  **Tra cứu giá bán**:\n    *   Người dùng có thể tra cứu giá bán của một mặt hàng dựa trên các tiêu chí (khách hàng, số lượng, ngày).\n\n## 3. Yêu Cầu Chức Năng\n\n### 3.1. Danh Sách Chức Năng\n\n| STT | Mã chức năng | Tên chức năng | Mô tả | Độ ưu tiên |\n|-----|--------------|---------------|-------|------------|\n| 1   | SP_001 | Quản lý Loại Giá Bán | Tạo, sửa, xóa, xem danh sách các loại giá bán. | Cao |\n| 2   | SP_002 | Quản lý Bảng Giá | Tạo, sửa, xóa, xem danh sách các mục trong bảng giá. | Cao |\n| 3   | SP_003 | Quản lý Giá Bán Chi Tiết (Tiered Pricing) | Thiết lập giá theo khoảng số lượng cho một mục trong bảng giá. | Cao |\n| 4   | SP_004 | Áp dụng giá tự động | Hệ thống tự động gợi ý/áp dụng giá vào đơn hàng, hóa đơn. | Cao |\n| 5   | SP_005 | Tra cứu lịch sử giá | Xem lại lịch sử thay đổi giá của một mặt hàng. | Trung bình |\n| 6   | SP_006 | Báo cáo phân tích giá | Các báo cáo liên quan đến giá bán, doanh thu theo giá. | Trung bình |\n\n### 3.2. Chi Tiết Chức Năng\n\n#### 3.2.1. SP_001: Quản lý Loại Giá Bán\n- **Mô tả**: Cho phép người dùng định nghĩa và quản lý các danh mục/loại giá bán.\n- **Đầu vào**: Mã loại giá, tên loại giá, trạng thái.\n- **Đầu ra**: Danh sách các loại giá bán, form tạo/sửa loại giá bán.\n- **Điều kiện tiên quyết**: Người dùng có quyền quản lý loại giá bán.\n- **Luồng xử lý chính**:\n  1.  Truy cập màn hình quản lý Loại Giá Bán.\n  2.  Hiển thị danh sách các loại giá bán hiện có.\n  3.  Cho phép thêm mới, sửa thông tin, thay đổi trạng thái của loại giá bán.\n- **Luồng xử lý thay thế/ngoại lệ**:\n  -   Lỗi trùng mã loại giá bán.\n  -   Không cho xóa loại giá bán đã được sử dụng trong các bảng giá.\n- **Giao diện liên quan**: Màn hình danh sách Loại Giá Bán, Form chi tiết Loại Giá Bán.\n\n#### 3.2.2. SP_002: Quản lý Bảng Giá\n- **Mô tả**: Cho phép người dùng tạo và duy trì các bảng giá cho từng mặt hàng.\n- **Đầu vào**: Thông tin mặt hàng, ĐVT, ngày hiệu lực, tiền tệ, giá cơ bản, loại giá bán, khách hàng (nếu có).\n- **Đầu ra**: Danh sách các mục trong bảng giá, form tạo/sửa mục bảng giá.\n- **Điều kiện tiên quyết**: Có thông tin mặt hàng, loại giá bán (nếu cần).\n- **Luồng xử lý chính**:\n  1.  Truy cập màn hình quản lý Bảng Giá.\n  2.  Lọc/tìm kiếm bảng giá theo mặt hàng, loại giá, khách hàng.\n  3.  Thêm mới một mục giá: chọn mặt hàng, nhập các thông tin liên quan.\n  4.  Sửa đổi một mục giá hiện có.\n- **Luồng xử lý thay thế/ngoại lệ**:\n  -   Giá trị không hợp lệ (ví dụ: giá âm).\n  -   Xung đột ngày hiệu lực nếu có nhiều bảng giá cho cùng một điều kiện.\n- **Giao diện liên quan**: Màn hình danh sách Bảng Giá, Form chi tiết Bảng Giá.\n\n#### 3.2.3. SP_003: Quản lý Giá Bán Chi Tiết (Tiered Pricing)\n- **Mô tả**: Cho phép thiết lập các bậc giá khác nhau cho một mục trong bảng giá dựa trên số lượng mua.\n- **Đầu vào**: Liên kết đến mục bảng giá, khoảng số lượng (từ - đến), giá hoặc tỷ lệ chiết khấu cho khoảng đó.\n- **Đầu ra**: Cấu trúc giá theo bậc được lưu lại.\n- **Điều kiện tiên quyết**: Đã có mục bảng giá (SP_002).\n- **Luồng xử lý chính**:\n  1.  Trong form chi tiết Bảng Giá, chọn mục \"Giá theo số lượng\".\n  2.  Thêm các dòng chi tiết, mỗi dòng là một khoảng số lượng và giá/chiết khấu tương ứng.\n  3.  Lưu lại.\n- **Luồng xử lý thay thế/ngoại lệ**:\n  -   Các khoảng số lượng không được chồng chéo.\n  -   Giá trị không hợp lệ.\n- **Giao diện liên quan**: Mục/Tab \"Giá theo số lượng\" trong Form chi tiết Bảng Giá.\n\n## 4. Thiết Kế Kỹ Thuật\n\n### 4.1. Kiến Trúc Hệ Thống\n\n```mermaid\nflowchart TD\n    WebApp[Giao diện Web] --\u003e APIGateway[API Gateway]\n    \n    APIGateway --\u003e LoaiGiaBanServiceAPI[/api/v1/sales-price-types/]\n    APIGateway --\u003e GiaBanServiceAPI[/api/v1/sales-prices/]\n    \n    LoaiGiaBanServiceAPI --\u003e LoaiGiaBanService[Dịch vụ Loại Giá Bán]\n    GiaBanServiceAPI --\u003e GiaBanService[Dịch vụ Bảng Giá]\n    \n    LoaiGiaBanService --\u003e Database[(Cơ sở dữ liệu - LoaiGiaBanModel)]\n    GiaBanService --\u003e DatabaseGiaBan[(Cơ sở dữ liệu - GiaBanModel, GiaBanChiTietModel)]\n```\n\n### 4.2. API Endpoints\n\n#### 4.2.1. Loại Giá Bán (LoaiGiaBanModel)\n- **Mô tả**: API quản lý các loại giá bán.\n- **URL**:\n  - `GET /api/v1/entity/{entity_slug}/erp/sales-price-types/`\n  - `POST /api/v1/entity/{entity_slug}/erp/sales-price-types/`\n  - `GET /api/v1/entity/{entity_slug}/erp/sales-price-types/{uuid}/`\n  - `PUT /api/v1/entity/{entity_slug}/erp/sales-price-types/{uuid}/`\n  - `PATCH /api/v1/entity/{entity_slug}/erp/sales-price-types/{uuid}/`\n  - `DELETE /api/v1/entity/{entity_slug}/erp/sales-price-types/{uuid}/`\n\n#### 4.2.2. Bảng Giá (GiaBanModel) và Chi Tiết Giá (GiaBanChiTietModel)\n- **Mô tả**: API quản lý bảng giá và chi tiết giá theo số lượng.\n- **URL**:\n  - `GET /api/v1/entity/{entity_slug}/erp/sales-prices/` (List, filter by material, customer, price type)\n  - `POST /api/v1/entity/{entity_slug}/erp/sales-prices/` (Create new price list, potentially with details)\n  - `GET /api/v1/entity/{entity_slug}/erp/sales-prices/{uuid}/` (Retrieve specific price list)\n  - `PUT /api/v1/entity/{entity_slug}/erp/sales-prices/{uuid}/` (Update price list, potentially with details)\n  - `DELETE /api/v1/entity/{entity_slug}/erp/sales-prices/{uuid}/` (Delete price list)\n  - `GET /api/v1/entity/{entity_slug}/erp/sales-prices/{gia_ban_uuid}/details/` (List details for a price list)\n  - `POST /api/v1/entity/{entity_slug}/erp/sales-prices/{gia_ban_uuid}/details/` (Add a detail)\n  - `PUT /api/v1/entity/{entity_slug}/erp/sales-prices/{gia_ban_uuid}/details/{detail_uuid}/` (Update a detail)\n  - `DELETE /api/v1/entity/{entity_slug}/erp/sales-prices/{gia_ban_uuid}/details/{detail_uuid}/` (Delete a detail)\n\n### 4.3. Service Logic\n\n#### 4.3.1. LoaiGiaBanModelService\n- **Mô tả**: Xử lý logic nghiệp vụ cho Loại Giá Bán.\n- **Chức năng chính**: CRUD, validation, lấy danh sách active/all.\n- **Dependencies**: `LoaiGiaBanRepository`.\n\n#### 4.3.2. GiaBanService\n- **Mô tả**: Xử lý logic nghiệp vụ cho Bảng Giá và Chi Tiết Giá.\n- **Chức năng chính**:\n    - CRUD cho `GiaBanModel`.\n    - Quản lý lồng ghép (nested) cho `GiaBanChiTietModel` khi tạo/cập nhật `GiaBanModel`.\n    - Validate dữ liệu (giá dương, không trùng lặp khoảng số lượng trong chi tiết).\n    - Logic truy vấn giá bán phù hợp cho đơn hàng.\n- **Dependencies**: `GiaBanRepository`, `GiaBanChiTietRepository`, `VatTuRepository`, `CustomerRepository`.\n\n### 4.4. Mô Hình Dữ Liệu\n\n#### 4.4.1. Entity Relationship Diagram (ERD)\n\n```mermaid\nerDiagram\n    LOAI_GIA_BAN ||--|{ GIA_BAN : \"áp dụng cho\"\n    VAT_TU ||--|{ GIA_BAN : \"có giá\"\n    KHACH_HANG ||--o{ GIA_BAN : \"có giá riêng\"\n    NHOM_KHACH_HANG ||--o{ GIA_BAN : \"có giá riêng\"\n    GIA_BAN ||--|{ GIA_BAN_CHI_TIET : \"có chi tiết theo SL\"\n    DON_VI_TINH ||--|{ GIA_BAN : \"theo\"\n    NGOAI_TE ||--|{ GIA_BAN : \"theo\"\n\n    LOAI_GIA_BAN {\n        uuid uuid PK\n        string ma_loai_gb \"Mã loại giá bán\"\n        string ten_loai_gb \"Tên loại giá bán\"\n        string ten_loai_gb2\n        integer status\n        uuid entity_model_id FK\n    }\n\n    GIA_BAN {\n        uuid uuid PK\n        uuid ma_vt_id FK \"Mã vật tư\"\n        uuid dvt_id FK \"Đơn vị tính\"\n        date ngay_hl \"Ngày hiệu lực\"\n        date ngay_het_hl \"Ngày hết hiệu lực\"\n        uuid ma_nt_id FK \"Mã ngoại tệ\"\n        decimal gia_ban \"Giá bán\"\n        boolean thue_yn \"Có thuế GTGT?\"\n        uuid ma_loai_gb_id FK \"Mã loại giá bán\"\n        uuid ma_kh_id FK \"Mã khách hàng (nếu có)\"\n        uuid nh_kh1_id FK \"Nhóm KH 1 (nếu có)\"\n        uuid nh_kh2_id FK \"Nhóm KH 2 (nếu có)\"\n        uuid nh_kh3_id FK \"Nhóm KH 3 (nếu có)\"\n        string ghi_chu\n        integer status\n        uuid entity_model_id FK\n    }\n\n    GIA_BAN_CHI_TIET {\n        uuid uuid PK\n        uuid gia_ban_id FK \"Liên kết bảng giá\"\n        decimal sl_tu \"Số lượng từ\"\n        decimal sl_den \"Số lượng đến\"\n        decimal gia_ban \"Giá cho khoảng SL này\"\n        decimal chiet_khau \"Chiết khấu %\"\n        integer status\n        uuid entity_model_id FK\n    }\n\n    VAT_TU { uuid uuid PK; string ma_vt; string ten_vt; }\n    KHACH_HANG { uuid uuid PK; string ma_kh; string ten_kh; }\n    NHOM_KHACH_HANG { uuid uuid PK; string ma_nhom; string ten_nhom; }\n    DON_VI_TINH { uuid uuid PK; string ma_dvt; }\n    NGOAI_TE { uuid uuid PK; string ma_nt; }\n```\n\n#### 4.4.2. Chi Tiết Bảng Dữ Liệu\n\n##### Bảng: LOAI_GIA_BAN (LoaiGiaBan)\n- **Mô tả**: Lưu trữ các loại giá bán.\n- **Các trường chính**: `uuid`, `ma_loai_gb`, `ten_loai_gb`, `status`, `entity_model_id`.\n\n##### Bảng: DMVT_GIA_BAN (GiaBanModel)\n- **Mô tả**: Lưu trữ bảng giá bán cho từng mặt hàng.\n- **Các trường chính**: `uuid`, `ma_vt_id` (FK VatTuModel), `dvt_id` (FK DonViTinhModel), `ngay_hl`, `ngay_het_hl`, `ma_nt_id` (FK NgoaiTeModel), `gia_ban`, `ma_loai_gb_id` (FK LoaiGiaBan), `ma_kh_id` (FK CustomerModel, nullable), `nh_kh1_id` (FK NhomKhachHang, nullable), `status`, `entity_model_id`.\n\n##### Bảng: DMVT_GIA_BAN_CT (GiaBanChiTietModel)\n- **Mô tả**: Lưu trữ chi tiết giá theo từng khoảng số lượng (tiered pricing).\n- **Các trường chính**: `uuid`, `gia_ban_id` (FK GiaBanModel), `sl_tu`, `sl_den`, `gia_ban`, `chiet_khau`, `status`, `entity_model_id`.\n\n## 5. Kế Hoạch Kiểm Thử\n\n### 5.1. Phạm Vi Kiểm Thử\n- Tạo/sửa/xóa Loại Giá Bán.\n- Tạo/sửa/xóa Bảng Giá (cho mặt hàng, theo loại giá, theo khách hàng, theo ngày hiệu lực).\n- Tạo/sửa/xóa Giá Bán Chi Tiết (tiered pricing).\n- Hệ thống tự động chọn đúng giá khi tạo đơn hàng/hóa đơn dựa trên các tiêu chí (mặt hàng, khách hàng, số lượng, ngày).\n- Kiểm tra tính đúng đắn của giá khi có nhiều bảng giá cùng điều kiện nhưng khác ngày hiệu lực.\n\n### 5.2. Kịch Bản Kiểm Thử\n\n| STT | Mã kịch bản | Tên kịch bản | Mô tả | Điều kiện tiên quyết | Các bước | Kết quả mong đợi |\n|-----|------------|--------------|-------|---------------------|----------|-----------------|\n| 1   | TC_SP_001 | Tạo Loại Giá Bán | Tạo mới một loại giá bán \"Giá bán lẻ\". | Đăng nhập, có quyền. | 1. Vào QL Loại Giá Bán.\u003cbr\u003e2. Thêm mới.\u003cbr\u003e3. Nhập Mã=\"RETAIL\", Tên=\"Giá bán lẻ\".\u003cbr\u003e4. Lưu. | Loại giá \"RETAIL\" được tạo thành công. |\n| 2   | TC_SP_002 | Tạo Bảng Giá cơ bản | Tạo giá cho SP001, loại giá RETAIL, giá 100,000 VND, hiệu lực từ hôm nay. | Có SP001, Loại giá RETAIL. | 1. Vào QL Bảng Giá.\u003cbr\u003e2. Thêm mới.\u003cbr\u003e3. Chọn SP001, ĐVT=Cái, Ngày HL=nay, Tiền tệ=VND, Giá=100000, Loại giá=RETAIL.\u003cbr\u003e4. Lưu. | Bảng giá được tạo. |\n| 3   | TC_SP_003 | Tạo Giá Bán Chi Tiết | Cho SP001, loại RETAIL: SL 1-10 giá 100K, SL 11-50 giá 95K. | Đã có TC_SP_002. | 1. Mở bảng giá của SP001 (từ TC_SP_002).\u003cbr\u003e2. Thêm chi tiết: SL 1-10, Giá 100000.\u003cbr\u003e3. Thêm chi tiết: SL 11-50, Giá 95000.\u003cbr\u003e4. Lưu. | Chi tiết giá được lưu. |\n| 4   | TC_SP_004 | Áp dụng giá vào Đơn hàng (SL \u003c 10) | Tạo đơn hàng cho SP001, SL=5. | Đã có TC_SP_003. | 1. Tạo Đơn hàng.\u003cbr\u003e2. Thêm SP001, SL=5.\u003cbr\u003e3. Chọn Khách hàng (không có giá riêng). | Hệ thống tự động áp giá 100,000. |\n| 5   | TC_SP_005 | Áp dụng giá vào Đơn hàng (SL \u003e 10) | Tạo đơn hàng cho SP001, SL=20. | Đã có TC_SP_003. | 1. Tạo Đơn hàng.\u003cbr\u003e2. Thêm SP001, SL=20.\u003cbr\u003e3. Chọn Khách hàng (không có giá riêng). | Hệ thống tự động áp giá 95,000. |\n| 6   | TC_SP_006 | Tạo Bảng Giá cho Khách hàng VIP | Tạo giá riêng cho SP001, KH VIP001, giá 90,000 VND. | Có SP001, KH VIP001. | 1. Vào QL Bảng Giá.\u003cbr\u003e2. Thêm mới.\u003cbr\u003e3. Chọn SP001, ĐVT=Cái, Ngày HL=nay, Tiền tệ=VND, Giá=90000, Khách hàng=VIP001.\u003cbr\u003e4. Lưu. | Bảng giá riêng cho VIP001 được tạo. |\n| 7   | TC_SP_007 | Áp dụng giá KH VIP | Tạo đơn hàng cho SP001, SL=5, KH VIP001. | Đã có TC_SP_003, TC_SP_006. | 1. Tạo Đơn hàng.\u003cbr\u003e2. Thêm SP001, SL=5.\u003cbr\u003e3. Chọn Khách hàng VIP001. | Hệ thống tự động áp giá 90,000 (ưu tiên giá KH). |\n\n## 6. Phụ Lục\n\n### 6.1. Danh Sách Tài Liệu Tham Khảo\n1. Tài liệu thiết kế hệ thống Django Ledger (Models: `LoaiGiaBan`, `GiaBanModel`, `GiaBanChiTietModel`).\n2. Các thông lệ về quản lý chính sách giá trong doanh nghiệp.\n\n### 6.2. Danh Mục Thuật Ngữ\n- ERP: Enterprise Resource Planning\n- API: Application Programming Interface\n- UUID: Universally Unique Identifier\n- GTGT: Giá Trị Gia Tăng (VAT)\n- ĐVT: Đơn Vị Tính\n- SL: Số Lượng\n- CK: Chiết Khấu\n\n### 6.3. Lịch Sử Thay Đổi Tài Liệu\n\n| Phiên bản | Ngày | Người thực hiện | Mô tả thay đổi |\n|-----------|------|-----------------|---------------|\n| 1.0 | 13/05/2025 | ChatGPT | Tạo mới tài liệu |\n"])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/SAL_003_Quan_Ly_Gia_Ban\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/SAL_003_Quan_Ly_Gia_Ban/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/SAL_003_Quan_Ly_Gia_Ban\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"SAL_003_Quan_Ly_Gia_Ban\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/SAL_003_Quan_Ly_Gia_Ban\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>