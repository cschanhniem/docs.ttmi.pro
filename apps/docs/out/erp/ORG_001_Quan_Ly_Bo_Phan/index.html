<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T5cad,"])</script><script>self.__next_f.push([1,"# ORG_001_Organization_Quản Lý Bộ Phận\n\n*Phiên bản: 1.0*\n*Người tạo: Cline*\n*Ngày tạo: 13/05/2025*\n*Cập nhật lần cuối: 13/05/2025*\n*Người cập nhật: Cline*\n\n## 1. Tổng Quan Nghiệp Vụ\n\n### 1.1. Mô Tả Nghiệp Vụ\nNghiệp vụ Quản Lý Bộ Phận cho phép người dùng định nghĩa, tổ chức và quản lý cấu trúc các phòng ban, bộ phận, đơn vị trong một công ty hoặc tổ chức. Mỗi bộ phận có thể được xác định bởi các thông tin như mã bộ phận, tên bộ phận, mô tả chi tiết, bộ phận cấp trên trực tiếp (bộ phận cha), và người quản lý trực tiếp. Nghiệp vụ này là nền tảng để xây dựng sơ đồ tổ chức, phân công trách nhiệm, quản lý nhân sự theo đơn vị, và phục vụ cho các quy trình báo cáo, phân quyền trong hệ thống ERP.\n\n### 1.2. Phạm Vi Áp Dụng\nÁp dụng cho bộ phận Nhân sự, Ban Giám đốc, và các Quản trị viên hệ thống có quyền thiết lập và duy trì cấu trúc tổ chức của công ty. Thông tin bộ phận được sử dụng rộng rãi trong các phân hệ khác như Kế toán (phân bổ chi phí), Nhân sự (quản lý nhân viên), Quản lý Tài sản (phân bổ tài sản), v.v.\n\n### 1.3. Định Nghĩa Thuật Ngữ\n| Thuật ngữ | Định nghĩa |\n|-----------|------------|\n| Bộ Phận (BoPhanModel) | Một đơn vị, phòng ban, hoặc nhóm chức năng trong cơ cấu tổ chức của công ty. |\n| Mã Bộ Phận (ma_bo_phan) | Mã định danh duy nhất cho mỗi bộ phận trong phạm vi một Entity. |\n| Tên Bộ Phận (ten_bo_phan) | Tên gọi chính thức của bộ phận. |\n| Bộ Phận Cha (bo_phan_cha) | Bộ phận cấp trên trực tiếp quản lý bộ phận hiện tại. Nếu là `null`, bộ phận này là cấp cao nhất (root). |\n| Người Quản Lý (nguoi_quan_ly) | Nhân viên được chỉ định làm người quản lý/trưởng của bộ phận. Liên kết tới `NhanVienModel` (ORG_002). |\n| Cây Cơ Cấu Tổ Chức | Sơ đồ phân cấp trực quan thể hiện mối quan hệ cha-con giữa các bộ phận. |\n| Trạng Thái (status) | Trạng thái hoạt động của bộ phận (ví dụ: 1 - Đang hoạt động, 0 - Ngừng hoạt động). |\n| Entity (Đơn vị) | Đơn vị/Công ty sử dụng hệ thống ERP. Mỗi bộ phận được quản lý trong phạm vi một Entity cụ thể. |\n\n### 1.4. Tài Liệu Liên Quan\n| STT | Mã tài liệu | Tên tài liệu | Mô tả |\n|-----|-------------|--------------|-------|\n| 1   | ORG_002 | Quản Lý Nhân Viên | Nhân viên thuộc về các bộ phận; người quản lý bộ phận là một nhân viên. |\n| 2   | ORG_003 | Phân Quyền Người Dùng | Quyền truy cập có thể được gán dựa trên vai trò và bộ phận của người dùng. |\n| 3   | ACC_001 | Sơ Đồ Tài Khoản | Chi phí có thể được hạch toán hoặc theo dõi theo bộ phận. |\n| 4   | AST_001 | Quản Lý Tài Sản Cố Định | Tài sản có thể được phân bổ và quản lý theo bộ phận sử dụng. |\n\n## 2. Quy Trình Nghiệp Vụ\n\n### 2.1. Tổng Quan Quy Trình\nQuy trình quản lý bộ phận bao gồm các hoạt động chính: tạo mới một bộ phận, cập nhật thông tin bộ phận hiện có, xem danh sách và chi tiết bộ phận, xem cây cơ cấu tổ chức, và vô hiệu hóa/xóa bộ phận (nếu các điều kiện cho phép).\n\n### 2.2. Sơ Đồ Quy Trình (Business Flow)\n\n```mermaid\nflowchart TD\n    A[Người dùng yêu cầu thao tác quản lý bộ phận] --\u003e B{Chọn thao tác};\n    B --\u003e|Thêm mới| C[Nhập thông tin bộ phận (Mã, Tên, Bộ phận cha, Người quản lý, ...)];\n    B --\u003e|Cập nhật| D[Chọn bộ phận \u0026 Nhập thông tin mới];\n    B --\u003e|Xóa/Vô hiệu hóa| E[Chọn bộ phận \u0026 Xác nhận];\n    B --\u003e|Xem danh sách| F[Hệ thống hiển thị danh sách bộ phận (có thể lọc, tìm kiếm)];\n    B --\u003e|Xem chi tiết| G[Chọn bộ phận \u0026 Hệ thống hiển thị chi tiết];\n    B --\u003e|Xem cây cơ cấu| H[Hệ thống hiển thị cây cơ cấu tổ chức];\n    \n    C --\u003e I[Hệ thống kiểm tra dữ liệu (Mã trùng, Bộ phận cha hợp lệ, ...)];\n    D --\u003e I;\n    \n    I --\u003e|Hợp lệ| J[Lưu thông tin vào CSDL];\n    I --\u003e|Không hợp lệ| K[Thông báo lỗi];\n    \n    J --\u003e L[Thông báo thành công];\n    \n    E --\u003e M[Hệ thống kiểm tra ràng buộc (Còn nhân viên? Còn tài sản phụ thuộc?)];\n    M --\u003e|Không có ràng buộc nghiêm trọng / Cho phép vô hiệu hóa| N[Cập nhật trạng thái (vô hiệu hóa) hoặc xóa nếu không có tham chiếu];\n    M --\u003e|Có ràng buộc không thể xóa| O[Thông báo lỗi không thể xóa/vô hiệu hóa];\n    \n    N --\u003e L;\n    \n    F --\u003e Z[Kết thúc];\n    G --\u003e Z;\n    H --\u003e Z;\n    K --\u003e A;\n    L --\u003e A;\n    O --\u003e A;\n```\n\n### 2.3. Chi Tiết Các Bước Quy Trình\n\n#### 2.3.1. Thêm Mới Bộ Phận\n- **Mô tả**: Người dùng tạo một bộ phận mới trong cơ cấu tổ chức.\n- **Đầu vào**: Mã bộ phận, tên bộ phận, mô tả (tùy chọn), UUID của bộ phận cha (tùy chọn), UUID của người quản lý (tùy chọn), trạng thái (mặc định là hoạt động).\n- **Đầu ra**: Bộ phận mới được tạo trong hệ thống.\n- **Người thực hiện**: Quản trị viên hệ thống, Bộ phận Nhân sự.\n- **Điều kiện tiên quyết**: Người dùng đã đăng nhập và có quyền. Bộ phận cha (nếu có) phải tồn tại. Người quản lý (nếu có) phải tồn tại. Mã bộ phận phải là duy nhất trong Entity.\n- **Xử lý ngoại lệ**:\n    - Mã bộ phận trùng: Thông báo lỗi.\n    - Bộ phận cha không tồn tại: Thông báo lỗi.\n    - Người quản lý không tồn tại: Thông báo lỗi.\n    - Không được tạo vòng lặp trong cây (A là cha B, B là cha A).\n\n#### 2.3.2. Cập Nhật Thông Tin Bộ Phận\n- **Mô tả**: Người dùng thay đổi thông tin của một bộ phận đã tồn tại.\n- **Đầu vào**: UUID của bộ phận cần cập nhật, các thông tin mới (tên, mô tả, bộ phận cha, người quản lý, trạng thái).\n- **Đầu ra**: Thông tin bộ phận được cập nhật.\n- **Người thực hiện**: Quản trị viên hệ thống, Bộ phận Nhân sự.\n- **Điều kiện tiên quyết**: Bộ phận tồn tại. Các điều kiện tương tự như thêm mới nếu các trường liên quan được thay đổi.\n- **Xử lý ngoại lệ**: Tương tự như thêm mới. Cẩn thận khi thay đổi bộ phận cha để tránh tạo vòng lặp hoặc phá vỡ cấu trúc.\n\n#### 2.3.3. Xóa/Vô Hiệu Hóa Bộ Phận\n- **Mô tả**: Người dùng xóa (logic bằng cách cập nhật trạng thái thành \"ngừng hoạt động\", hoặc xóa vật lý nếu không có ràng buộc) một bộ phận.\n- **Đầu vào**: UUID của bộ phận cần xóa/vô hiệu hóa.\n- **Đầu ra**: Bộ phận được đánh dấu ngừng hoạt động hoặc bị xóa.\n- **Người thực hiện**: Quản trị viên hệ thống, Bộ phận Nhân sự.\n- **Điều kiện tiên quyết**: Bộ phận tồn tại.\n- **Xử lý ngoại lệ**:\n    - Nếu bộ phận có bộ phận con đang hoạt động: Không cho xóa/vô hiệu hóa (hoặc yêu cầu xử lý các bộ phận con trước).\n    - Nếu bộ phận có nhân viên đang thuộc về: Không cho xóa (yêu cầu chuyển nhân viên sang bộ phận khác hoặc xử lý nhân viên trước).\n    - Nếu bộ phận đang được tham chiếu bởi các dữ liệu quan trọng khác: Cân nhắc chỉ cho phép vô hiệu hóa.\n\n#### 2.3.4. Xem Danh Sách Bộ Phận\n- **Mô tả**: Người dùng xem danh sách các bộ phận, có thể kèm theo tìm kiếm, lọc theo trạng thái, bộ phận cha, và phân trang.\n- **Đầu vào**: Entity slug, các tham số lọc và phân trang.\n- **Đầu ra**: Danh sách các bộ phận.\n- **Người thực hiện**: Mọi người dùng có quyền xem.\n\n#### 2.3.5. Xem Chi Tiết Bộ Phận\n- **Mô tả**: Người dùng xem thông tin chi tiết của một bộ phận cụ thể, bao gồm danh sách nhân viên thuộc bộ phận (nếu có quyền).\n- **Đầu vào**: UUID của bộ phận.\n- **Đầu ra**: Thông tin chi tiết của bộ phận.\n- **Người thực hiện**: Mọi người dùng có quyền xem.\n\n#### 2.3.6. Xem Cây Cơ Cấu Tổ Chức\n- **Mô tả**: Hiển thị trực quan cấu trúc phân cấp của các bộ phận.\n- **Đầu vào**: Entity slug.\n- **Đầu ra**: Sơ đồ cây các bộ phận.\n- **Người thực hiện**: Mọi người dùng có quyền xem.\n\n### 2.4. Sơ Đồ Tuần Tự (Sequence Diagram) - Thêm Mới Bộ Phận\n\n```mermaid\nsequenceDiagram\n    participant User as Người dùng\n    participant System as Hệ thống (API)\n    participant Service as BoPhanModelService\n    participant Repository as BoPhanRepository\n    participant ParentRepo as BoPhanRepository (cho Bộ phận cha)\n    participant EmployeeRepo as NhanVienRepository (cho Người quản lý)\n    participant DB as Cơ sở dữ liệu\n\n    User-\u003e\u003eSystem: POST /api/{entity_slug}/bo-phan/ (data: ma_bo_phan, ten_bo_phan, bo_phan_cha_uuid, nguoi_quan_ly_uuid, ...)\n    System-\u003e\u003eService: create_bo_phan(entity_slug, data)\n    Service-\u003e\u003eService: _get_entity_model(entity_slug)\n    Service--\u003e\u003eService: entity_model\n    \n    alt Nếu có bo_phan_cha_uuid\n        Service-\u003e\u003eParentRepo: get_bo_phan_by_uuid(data['bo_phan_cha_uuid'])\n        ParentRepo-\u003e\u003eDB: SELECT * FROM BoPhanModel WHERE uuid = ...\n        DB--\u003e\u003eParentRepo: bo_phan_cha_model (or null)\n        ParentRepo--\u003e\u003eService: bo_phan_cha_model (or null)\n        alt Bộ phận cha không tồn tại\n            Service--\u003e\u003eSystem: Error: \"Parent Department not found\"\n            System--\u003e\u003eUser: Response 400 (Error message)\n        end\n    end\n\n    alt Nếu có nguoi_quan_ly_uuid\n        Service-\u003e\u003eEmployeeRepo: get_nhan_vien_by_uuid(data['nguoi_quan_ly_uuid'])\n        EmployeeRepo-\u003e\u003eDB: SELECT * FROM NhanVienModel WHERE uuid = ...\n        DB--\u003e\u003eEmployeeRepo: nguoi_quan_ly_model (or null)\n        EmployeeRepo--\u003e\u003eService: nguoi_quan_ly_model (or null)\n        alt Người quản lý không tồn tại\n            Service--\u003e\u003eSystem: Error: \"Manager not found\"\n            System--\u003e\u003eUser: Response 400 (Error message)\n        end\n    end\n\n    Service-\u003e\u003eRepository: check_ma_bo_phan_exists(entity_model, data['ma_bo_phan'])\n    Repository-\u003e\u003eDB: SELECT 1 FROM BoPhanModel WHERE entity_id = ... AND ma_bo_phan = ...\n    DB--\u003e\u003eRepository: exists (true/false)\n    Repository--\u003e\u003eService: exists (true/false)\n    alt Mã bộ phận đã tồn tại\n        Service--\u003e\u003eSystem: Error: \"Department code already exists\"\n        System--\u003e\u003eUser: Response 400 (Error message)\n    else Mã bộ phận hợp lệ\n        Service-\u003e\u003eService: validate_bo_phan_data(data)\n        Service--\u003e\u003eService: validated_data\n        Service-\u003e\u003eRepository: create_bo_phan(entity_model, validated_data, bo_phan_cha_model, nguoi_quan_ly_model)\n        Repository-\u003e\u003eDB: INSERT INTO BoPhanModel (...) VALUES (...)\n        DB--\u003e\u003eRepository: new_bo_phan_object\n        Repository--\u003e\u003eService: new_bo_phan_object\n        Service--\u003e\u003eSystem: new_bo_phan_object_with_details\n        System--\u003e\u003eUser: Response 201 (new_bo_phan_data)\n    end\n```\n\n### 2.5. Luồng Nghiệp Vụ Thay Thế\n- **Thay đổi cấu trúc hàng loạt**: Có thể có nhu cầu tái cấu trúc (di chuyển bộ phận, sáp nhập) thông qua một giao diện chuyên biệt hoặc import.\n- **Quản lý lịch sử thay đổi người quản lý**: Lưu lại lịch sử ai đã quản lý bộ phận vào thời điểm nào.\n\n## 3. Yêu Cầu Chức Năng\n\n### 3.1. Danh Sách Chức Năng\n\n| STT | Mã chức năng | Tên chức năng | Mô tả | Độ ưu tiên |\n|-----|--------------|---------------|-------|------------|\n| 1   | ORG_001_F01 | Thêm mới bộ phận | Cho phép tạo một bộ phận mới. | Cao |\n| 2   | ORG_001_F02 | Cập nhật bộ phận | Cho phép sửa thông tin của một bộ phận đã có. | Cao |\n| 3   | ORG_001_F03 | Xóa/Vô hiệu hóa bộ phận | Cho phép xóa (logic/vật lý) hoặc vô hiệu hóa một bộ phận. | Cao |\n| 4   | ORG_001_F04 | Xem danh sách bộ phận | Hiển thị danh sách các bộ phận, hỗ trợ phân trang, tìm kiếm và lọc. | Cao |\n| 5   | ORG_001_F05 | Xem chi tiết bộ phận | Hiển thị thông tin chi tiết của một bộ phận. | Cao |\n| 6   | ORG_001_F06 | Xem cây cơ cấu tổ chức | Hiển thị cấu trúc phân cấp của các bộ phận. | Cao |\n| 7   | ORG_001_F07 | Gán/thay đổi người quản lý | Cho phép gán hoặc thay đổi người quản lý cho bộ phận. | Cao |\n\n### 3.2. Chi Tiết Chức Năng\n\n#### 3.2.1. ORG_001_F01: Thêm mới bộ phận\n- **Mô tả**: Chức năng cho phép người dùng tạo mới một bộ phận.\n- **Đầu vào**:\n    - `entity_slug`: Slug của Entity.\n    - `data`: Đối tượng chứa thông tin bộ phận:\n        - `ma_bo_phan` (bắt buộc, unique): Mã bộ phận.\n        - `ten_bo_phan` (bắt buộc): Tên bộ phận.\n        - `mo_ta` (tùy chọn): Mô tả.\n        - `bo_phan_cha_uuid` (tùy chọn): UUID của bộ phận cha.\n        - `nguoi_quan_ly_uuid` (tùy chọn): UUID của nhân viên quản lý.\n        - `status` (tùy chọn, default=1): Trạng thái.\n- **Đầu ra**: Đối tượng `BoPhanModel` vừa được tạo.\n- **Điều kiện tiên quyết**: `entity_slug` hợp lệ. `ma_bo_phan` chưa tồn tại. `bo_phan_cha_uuid` (nếu có) phải hợp lệ và không tạo vòng lặp. `nguoi_quan_ly_uuid` (nếu có) phải hợp lệ.\n- **Luồng xử lý chính**:\n  1. Service kiểm tra `EntityModel`.\n  2. Service kiểm tra tính duy nhất của `ma_bo_phan`.\n  3. Service kiểm tra sự tồn tại và hợp lệ của `BoPhanModel` cha (nếu có).\n  4. Service kiểm tra sự tồn tại của `NhanVienModel` quản lý (nếu có).\n  5. Service gọi Repository để tạo mới.\n- **Giao diện liên quan**: Form thêm mới bộ phận.\n\n#### 3.2.2. ORG_001_F02: Cập nhật bộ phận\n- **Mô tả**: Cập nhật thông tin bộ phận.\n- **Đầu vào**: `entity_slug`, `uuid` của bộ phận, `data` thông tin cập nhật.\n- **Đầu ra**: Đối tượng `BoPhanModel` đã cập nhật.\n- **Điều kiện tiên quyết**: Bộ phận tồn tại. Các điều kiện tương tự F01 nếu các trường liên quan được thay đổi.\n- **Giao diện liên quan**: Form cập nhật bộ phận.\n\n#### 3.2.3. ORG_001_F03: Xóa/Vô hiệu hóa bộ phận\n- **Mô tả**: Xóa hoặc vô hiệu hóa một bộ phận.\n- **Đầu vào**: `entity_slug`, `uuid` của bộ phận.\n- **Đầu ra**: HTTP 204 No Content (nếu xóa vật lý) hoặc đối tượng bộ phận đã cập nhật trạng thái.\n- **Điều kiện tiên quyết**: Bộ phận tồn tại. Kiểm tra các ràng buộc (bộ phận con, nhân viên, tài sản...).\n- **Giao diện liên quan**: Nút xóa/vô hiệu hóa.\n\n#### 3.2.4. ORG_001_F04: Xem danh sách bộ phận\n- **Mô tả**: Lấy danh sách bộ phận, có phân trang, tìm kiếm, lọc.\n- **Đầu vào**: `entity_slug`, `page`, `page_size`, các tham số lọc (ví dụ: `search_term`, `status`, `bo_phan_cha_uuid`).\n- **Đầu ra**: Danh sách `BoPhanModel`.\n- **Giao diện liên quan**: Trang danh sách bộ phận.\n\n#### 3.2.5. ORG_001_F06: Xem cây cơ cấu tổ chức\n- **Mô tả**: Lấy dữ liệu để hiển thị cây cơ cấu tổ chức.\n- **Đầu vào**: `entity_slug`.\n- **Đầu ra**: Dữ liệu dạng cây (ví dụ: JSON lồng nhau) của các bộ phận.\n- **Giao diện liên quan**: Trang hiển thị cây cơ cấu.\n\n## 4. Thiết Kế Kỹ Thuật\n\n### 4.1. Kiến Trúc Hệ Thống\nSử dụng Views/APIs, Services (`BoPhanModelService`), Repositories (`BoPhanRepository`), Models (`BoPhanModel`, `NhanVienModel`, `EntityModel`). Cân nhắc sử dụng thư viện như `django-mptt` để quản lý hiệu quả cấu trúc cây.\n\n### 4.2. API Endpoints\n\n- **Base URL**: `/api/{entity_slug}/bo-phan/`\n- **Endpoints**:\n    - `GET /`: Lấy danh sách bộ phận. (ORG_001_F04)\n        - Query params: `page`, `page_size`, `search`, `status`, `bo_phan_cha_uuid`.\n    - `GET /tree/`: Lấy dữ liệu cây cơ cấu tổ chức. (ORG_001_F06)\n    - `POST /`: Tạo mới bộ phận. (ORG_001_F01)\n    - `GET /{uuid}/`: Lấy chi tiết bộ phận. (ORG_001_F05)\n    - `PUT /{uuid}/`: Cập nhật toàn bộ bộ phận. (ORG_001_F02)\n    - `PATCH /{uuid}/`: Cập nhật một phần bộ phận. (ORG_001_F02)\n    - `DELETE /{uuid}/`: Xóa bộ phận (thường là vô hiệu hóa). (ORG_001_F03)\n\n### 4.3. Service Logic (`BoPhanModelService`)\n- Xử lý logic tạo/cập nhật bộ phận, đảm bảo tính toàn vẹn của cấu trúc cây (không có vòng lặp, bộ phận cha hợp lệ).\n- Kiểm tra ràng buộc trước khi xóa/vô hiệu hóa.\n- Logic lấy dữ liệu cho cây cơ cấu (nếu không dùng `django-mptt` thì cần xây dựng đệ quy hoặc truy vấn phù hợp).\n\n### 4.4. Mô Hình Dữ Liệu\n\n#### 4.4.1. Entity Relationship Diagram (ERD)\n\n```mermaid\nerDiagram\n    ENTITY ||--|{ BO_PHAN : \"quản lý\"\n    BO_PHAN }o--|| BO_PHAN : \"là cha của (parent_of)\"\n    NHAN_VIEN {\n        uuid uuid PK\n        string ho_ten\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n    BO_PHAN }o--|| NHAN_VIEN : \"được quản lý bởi (managed_by)\"\n    BO_PHAN ||--o{ NHAN_VIEN : \"bao gồm (contains_employees)\"\n\n    ENTITY {\n        uuid uuid PK\n        string slug\n        string name\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    BO_PHAN {\n        uuid uuid PK\n        string ma_bo_phan \"Mã bộ phận (unique)\"\n        string ten_bo_phan \"Tên bộ phận\"\n        text mo_ta \"Mô tả\"\n        integer status \"Trạng thái\"\n        datetime created\n        datetime updated\n        uuid entity_id FK \"Khóa ngoại tới ENTITY\"\n        uuid bo_phan_cha_id FK \"Khóa ngoại tới BO_PHAN (self)\"\n        uuid nguoi_quan_ly_id FK \"Khóa ngoại tới NHAN_VIEN\"\n        \u003cem\u003einteger lft (django-mptt)\u003c/em\u003e\n        \u003cem\u003einteger rght (django-mptt)\u003c/em\u003e\n        \u003cem\u003einteger tree_id (django-mptt)\u003c/em\u003e\n        \u003cem\u003einteger level (django-mptt)\u003c/em\u003e\n    }\n```\n*Lưu ý: Các trường `lft`, `rght`, `tree_id`, `level` là tùy chọn nếu sử dụng `django-mptt`.*\n\n#### 4.4.2. Chi Tiết Bảng Dữ Liệu\n\n##### Bảng: `BoPhanModel` (django_ledger_bophanmodel)\n- **Mô tả**: Lưu trữ thông tin các bộ phận trong công ty.\n- **Các cột chính**:\n    - `uuid` (UUID, Khóa chính).\n    - `entity_model` (ForeignKey đến `EntityModel`).\n    - `ma_bo_phan` (CharField, max_length=50, unique_together_with=`entity_model`).\n    - `ten_bo_phan` (CharField, max_length=255).\n    - `mo_ta` (TextField, null=True, blank=True).\n    - `bo_phan_cha` (ForeignKey đến `self` trên `BoPhanModel`, on_delete=models.PROTECT, null=True, blank=True, related_name='bo_phan_con').\n    - `nguoi_quan_ly` (ForeignKey đến `NhanVienModel` (ORG_002), on_delete=models.SET_NULL, null=True, blank=True).\n    - `status` (IntegerField, default=1, choices=((1, 'Đang hoạt động'), (0, 'Ngừng hoạt động'))).\n    - `created` (DateTimeField, auto_now_add=True).\n    - `updated` (DateTimeField, auto_now=True).\n    - *(Nếu dùng django-mptt: `lft`, `rght`, `tree_id`, `level`)*\n- **Indexes**:\n    - Index trên (`entity_model`, `ma_bo_phan`).\n    - Index trên (`entity_model`, `bo_phan_cha`).\n    - *(django-mptt sẽ tự tạo các index cần thiết cho các trường của nó)*.\n\n## 5. Kế Hoạch Kiểm Thử\n\n### 5.1. Phạm Vi Kiểm Thử\n- CRUD cho Bộ Phận.\n- Quản lý cấu trúc cây: gán bộ phận cha, di chuyển bộ phận trong cây.\n- Kiểm tra không cho phép tạo vòng lặp trong cây.\n- Gán/thay đổi người quản lý.\n- Xử lý xóa/vô hiệu hóa bộ phận và các ràng buộc liên quan (nhân viên, bộ phận con).\n- Tìm kiếm, lọc, phân trang danh sách bộ phận.\n- Hiển thị cây cơ cấu tổ chức.\n\n### 5.2. Kịch Bản Kiểm Thử (Ví dụ)\n\n| STT | Mã kịch bản | Tên kịch bản | Mô tả | Điều kiện tiên quyết | Các bước | Kết quả mong đợi |\n|-----|------------|--------------|-------|---------------------|----------|-----------------|\n| 1   | ORG_001_TC01 | Thêm mới bộ phận gốc thành công | Tạo bộ phận không có cha. | User đăng nhập, có quyền. Entity \"E1\" tồn tại. | 1. POST `/api/E1/bo-phan/`. 2. Payload: `{\"ma_bo_phan\": \"GD\", \"ten_bo_phan\": \"Ban Giám Đốc\"}`. | 1. HTTP 201. 2. Dữ liệu bộ phận được trả về. 3. Bộ phận được lưu vào CSDL, `bo_phan_cha` là null. |\n| 2   | ORG_001_TC02 | Thêm mới bộ phận con thành công | Tạo bộ phận có cha là \"GD\". | Bộ phận \"GD\" (uuid_gd) tồn tại. | 1. POST `/api/E1/bo-phan/`. 2. Payload: `{\"ma_bo_phan\": \"KT\", \"ten_bo_phan\": \"Phòng Kế Toán\", \"bo_phan_cha_uuid\": \"uuid_gd\"}`. | 1. HTTP 201. 2. Dữ liệu bộ phận được trả về. 3. Bộ phận \"KT\" có `bo_phan_cha` là \"GD\". |\n| 3   | ORG_001_TC03 | Thêm mới bộ phận với mã trùng | Cố gắng tạo bộ phận có mã \"KT\" đã tồn tại. | Bộ phận \"KT\" đã tồn tại. | 1. POST `/api/E1/bo-phan/`. 2. Payload: `{\"ma_bo_phan\": \"KT\", \"ten_bo_phan\": \"Phòng Kỹ Thuật\"}`. | 1. HTTP 400. 2. Lỗi \"Mã bộ phận đã tồn tại\". |\n| 4   | ORG_001_TC04 | Cập nhật tên bộ phận | Thay đổi tên bộ phận \"KT\". | Bộ phận \"KT\" (uuid_kt) tồn tại. | 1. PATCH `/api/E1/bo-phan/uuid_kt/`. 2. Payload: `{\"ten_bo_phan\": \"Phòng Kế Toán Tài Chính\"}`. | 1. HTTP 200. 2. Tên bộ phận được cập nhật. |\n| 5   | ORG_001_TC05 | Vô hiệu hóa bộ phận có nhân viên | Cố gắng vô hiệu hóa bộ phận \"KT\" khi còn nhân viên. | Bộ phận \"KT\" có nhân viên. | 1. DELETE `/api/E1/bo-phan/uuid_kt/` (hoặc PATCH để cập nhật status=0). | 1. HTTP 400 (nếu logic không cho phép) hoặc HTTP 200 với thông báo/cảnh báo. 2. Lỗi \"Bộ phận còn nhân viên\" hoặc bộ phận được vô hiệu hóa nhưng có cảnh báo. (Tùy theo logic xử lý). |\n| 6   | ORG_001_TC06 | Xem cây cơ cấu tổ chức | Kiểm tra hiển thị cây. | Có ít nhất 2 bộ phận cha-con. | 1. GET `/api/E1/bo-phan/tree/`. | 1. HTTP 200. 2. Dữ liệu trả về có cấu trúc cây JSON đúng. |\n\n## 6. Phụ Lục\n\n### 6.1. Danh Sách Tài Liệu Tham Khảo\n- Django MPTT documentation (nếu sử dụng): [https://django-mptt.readthedocs.io/](https://django-mptt.readthedocs.io/)\n- Mã nguồn Django Ledger: `django_ledger/models/organization.py` (dự kiến, có thể chứa `BoPhanModel`)\n- Mã nguồn Django Ledger: `django_ledger/services/organization/department.py` (dự kiến)\n\n### 6.2. Danh Mục Thuật Ngữ\n(Đã định nghĩa ở mục 1.3)\n\n### 6.3. Lịch Sử Thay Đổi Tài Liệu\n\n| Phiên bản | Ngày | Người thực hiện | Mô tả thay đổi |\n|-----------|------|-----------------|---------------|\n| 1.0 | 13/05/2025 | Cline | Tạo mới tài liệu. |\n"])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/ORG_001_Quan_Ly_Bo_Phan\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/ORG_001_Quan_Ly_Bo_Phan/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/ORG_001_Quan_Ly_Bo_Phan\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"ORG_001_Quan_Ly_Bo_Phan\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/ORG_001_Quan_Ly_Bo_Phan\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>