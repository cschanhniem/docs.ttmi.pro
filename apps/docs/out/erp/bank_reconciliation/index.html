<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T3472,"])</script><script>self.__next_f.push([1,"# Hướng Dẫn Đối Chiếu Ngân Hàng và Xử Lý Thanh Toán\n\n## 1. Đối Chiếu Ngân Hàng\n\n### 1.1. Import Sao Kê Ngân Hàng\n```python\ndef import_bank_statement(entity_model, bank_account, statement_file):\n    \"\"\"\n    Import sao kê từ file ngân hàng\n    Hỗ trợ các định dạng:\n    - Vietcombank (.xlsx)\n    - BIDV (.xls)\n    - Techcombank (.csv)\n    - VietinBank (.xlsx)\n    \"\"\"\n    from pandas import read_excel, read_csv\n    \n    # Xác định ngân hàng và đọc file\n    bank_type = bank_account.bank_type\n    if bank_type == 'vcb':\n        df = read_excel(statement_file, sheet_name=0)\n        mapping = {\n            'date': 'Ngày giao dịch',\n            'description': 'Mô tả',\n            'amount': 'Số tiền',\n            'type': 'Loại giao dịch'\n        }\n    elif bank_type == 'bidv':\n        # Mapping tương tự cho BIDV\n        pass\n        \n    # Chuẩn hóa dữ liệu\n    transactions = []\n    for _, row in df.iterrows():\n        transactions.append({\n            'date': parse_date(row[mapping['date']]),\n            'description': row[mapping['description']],\n            'amount': parse_amount(row[mapping['amount']]),\n            'type': parse_transaction_type(row[mapping['type']])\n        })\n    \n    return transactions\n```\n\n### 1.2. Đối Chiếu Tự Động\n```python\ndef auto_reconcile(entity_model, bank_account, start_date, end_date):\n    \"\"\"\n    Đối chiếu tự động giao dịch ngân hàng\n    \"\"\"\n    # Lấy giao dịch từ sổ kế toán\n    accounting_entries = TransactionModel.objects.filter(\n        journal_entry__ledger__entity=entity_model,\n        account_id='112',  # TK Tiền gửi ngân hàng\n        bank_account=bank_account,\n        journal_entry__date__range=[start_date, end_date]\n    )\n    \n    # Lấy giao dịch từ sao kê\n    bank_entries = BankStatementModel.objects.filter(\n        entity=entity_model,\n        bank_account=bank_account,\n        date__range=[start_date, end_date]\n    )\n    \n    matches = []\n    unmatched_accounting = []\n    unmatched_bank = []\n    \n    # Đối chiếu theo số tiền và ngày\n    for acc_entry in accounting_entries:\n        found = False\n        for bank_entry in bank_entries:\n            if (abs(acc_entry.amount - bank_entry.amount) \u003c Decimal('0.01') and\n                abs(acc_entry.date - bank_entry.date).days \u003c= 1):\n                matches.append({\n                    'accounting': acc_entry,\n                    'bank': bank_entry\n                })\n                found = True\n                break\n        if not found:\n            unmatched_accounting.append(acc_entry)\n            \n    # Tìm các giao dịch ngân hàng chưa đối chiếu\n    matched_bank_ids = [m['bank'].id for m in matches]\n    unmatched_bank = bank_entries.exclude(id__in=matched_bank_ids)\n    \n    return {\n        'matches': matches,\n        'unmatched_accounting': unmatched_accounting,\n        'unmatched_bank': unmatched_bank\n    }\n```\n\n### 1.3. Xử Lý Chênh Lệch\n```python\ndef xu_ly_chenh_lech(entity_model, bank_account, reconciliation_date):\n    \"\"\"\n    Xử lý chênh lệch số dư ngân hàng\n    \"\"\"\n    # Lấy số dư kế toán\n    so_du_ke_toan = get_account_balance(\n        entity_model,\n        '112',\n        bank_account,\n        reconciliation_date\n    )\n    \n    # Lấy số dư ngân hàng\n    so_du_ngan_hang = get_bank_balance(\n        bank_account,\n        reconciliation_date\n    )\n    \n    # Tìm các nguyên nhân chênh lệch\n    chenh_lech = []\n    \n    # 1. Séc chờ thanh toán\n    sec_cho_thanh_toan = get_outstanding_checks(\n        entity_model,\n        bank_account,\n        reconciliation_date\n    )\n    \n    # 2. Tiền gửi trên đường\n    tien_gui_tren_duong = get_deposits_in_transit(\n        entity_model,\n        bank_account,\n        reconciliation_date\n    )\n    \n    # 3. Phí ngân hàng chưa ghi nhận\n    phi_chua_ghi_nhan = get_unrecorded_bank_fees(\n        entity_model,\n        bank_account,\n        reconciliation_date\n    )\n    \n    # Tính toán chênh lệch còn lại\n    chenh_lech_con_lai = (\n        so_du_ngan_hang -\n        so_du_ke_toan -\n        sum(c.amount for c in sec_cho_thanh_toan) +\n        sum(t.amount for t in tien_gui_tren_duong) -\n        sum(p.amount for p in phi_chua_ghi_nhan)\n    )\n    \n    return {\n        'so_du_ke_toan': so_du_ke_toan,\n        'so_du_ngan_hang': so_du_ngan_hang,\n        'sec_cho_thanh_toan': sec_cho_thanh_toan,\n        'tien_gui_tren_duong': tien_gui_tren_duong,\n        'phi_chua_ghi_nhan': phi_chua_ghi_nhan,\n        'chenh_lech_con_lai': chenh_lech_con_lai\n    }\n```\n\n## 2. Quy Trình Thanh Toán\n\n### 2.1. Thanh Toán Nhà Cung Cấp\n```python\ndef tao_de_nghi_thanh_toan(entity_model, payment_data):\n    \"\"\"\n    Tạo đề nghị thanh toán cho nhà cung cấp\n    \"\"\"\n    # Tạo chứng từ\n    payment_request = PaymentRequestModel.objects.create(\n        entity=entity_model,\n        vendor=payment_data['vendor'],\n        amount=payment_data['amount'],\n        due_date=payment_data['due_date'],\n        payment_method=payment_data['payment_method'],\n        description=payment_data['description']\n    )\n    \n    # Thêm các hóa đơn cần thanh toán\n    for bill in payment_data['bills']:\n        PaymentRequestLineModel.objects.create(\n            payment_request=payment_request,\n            bill=bill,\n            amount=bill.amount_due\n        )\n    \n    return payment_request\n```\n\n### 2.2. Xử Lý Phê Duyệt\n```python\ndef xu_ly_phe_duyet_thanh_toan(payment_request, approver, action, notes=None):\n    \"\"\"\n    Xử lý phê duyệt đề nghị thanh toán\n    \"\"\"\n    if action == 'approve':\n        # Kiểm tra thẩm quyền\n        if not has_approval_authority(approver, payment_request.amount):\n            raise ValidationError('Không đủ thẩm quyền phê duyệt')\n            \n        # Tạo bản ghi phê duyệt\n        PaymentApprovalModel.objects.create(\n            payment_request=payment_request,\n            approver=approver,\n            action='approve',\n            notes=notes\n        )\n        \n        # Cập nhật trạng thái\n        payment_request.status = 'approved'\n        payment_request.save()\n        \n        # Tạo Ủy nhiệm chi nếu là chuyển khoản\n        if payment_request.payment_method == 'bank_transfer':\n            create_bank_payment_order(payment_request)\n            \n    elif action == 'reject':\n        PaymentApprovalModel.objects.create(\n            payment_request=payment_request,\n            approver=approver,\n            action='reject',\n            notes=notes\n        )\n        payment_request.status = 'rejected'\n        payment_request.save()\n```\n\n### 2.3. Xuất Ủy Nhiệm Chi\n```python\ndef tao_uy_nhiem_chi(payment_request):\n    \"\"\"\n    Tạo ủy nhiệm chi từ đề nghị thanh toán\n    \"\"\"\n    unc = BankPaymentOrderModel.objects.create(\n        entity=payment_request.entity,\n        payment_request=payment_request,\n        beneficiary_name=payment_request.vendor.name,\n        beneficiary_account=payment_request.vendor.bank_account,\n        beneficiary_bank=payment_request.vendor.bank_name,\n        amount=payment_request.amount,\n        description=payment_request.description\n    )\n    \n    return unc\n\ndef xuat_unc_xml(unc):\n    \"\"\"\n    Xuất ủy nhiệm chi dạng XML theo chuẩn ngân hàng\n    \"\"\"\n    root = Element('UyNhiemChi')\n    \n    # Thông tin chung\n    info = SubElement(root, 'ThongTinChung')\n    SubElement(info, 'MaUNC').text = unc.number\n    SubElement(info, 'NgayLap').text = unc.created_at.strftime('%Y-%m-%d')\n    \n    # Thông tin người chuyển\n    sender = SubElement(root, 'NguoiChuyen')\n    SubElement(sender, 'TenTaiKhoan').text = unc.entity.name\n    SubElement(sender, 'SoTaiKhoan').text = unc.entity.bank_account\n    \n    # Thông tin người nhận\n    receiver = SubElement(root, 'NguoiNhan')\n    SubElement(receiver, 'TenTaiKhoan').text = unc.beneficiary_name\n    SubElement(receiver, 'SoTaiKhoan').text = unc.beneficiary_account\n    SubElement(receiver, 'NganHang').text = unc.beneficiary_bank\n    \n    # Thông tin giao dịch\n    transaction = SubElement(root, 'ThongTinGiaoDich')\n    SubElement(transaction, 'SoTien').text = str(unc.amount)\n    SubElement(transaction, 'NoiDung').text = unc.description\n    \n    return tostring(root, encoding='utf-8', xml_declaration=True)\n```\n\n## 3. Báo Cáo Thanh Toán\n\n### 3.1. Báo Cáo Tuổi Nợ\n```python\ndef bao_cao_tuoi_no_nha_cung_cap(entity_model, as_of_date):\n    \"\"\"\n    Báo cáo tuổi nợ nhà cung cấp\n    \"\"\"\n    vendors = VendorModel.objects.filter(entity=entity_model)\n    report = []\n    \n    for vendor in vendors:\n        bills = BillModel.objects.filter(\n            entity=entity_model,\n            vendor=vendor,\n            due_date__lte=as_of_date,\n            status='unpaid'\n        )\n        \n        aging_buckets = {\n            'current': Decimal('0'),\n            '1_30': Decimal('0'),\n            '31_60': Decimal('0'),\n            '61_90': Decimal('0'),\n            'over_90': Decimal('0')\n        }\n        \n        for bill in bills:\n            days_overdue = (as_of_date - bill.due_date).days\n            \n            if days_overdue \u003c= 0:\n                aging_buckets['current'] += bill.amount_due\n            elif days_overdue \u003c= 30:\n                aging_buckets['1_30'] += bill.amount_due\n            elif days_overdue \u003c= 60:\n                aging_buckets['31_60'] += bill.amount_due\n            elif days_overdue \u003c= 90:\n                aging_buckets['61_90'] += bill.amount_due\n            else:\n                aging_buckets['over_90'] += bill.amount_due\n                \n        report.append({\n            'vendor': vendor,\n            'aging': aging_buckets,\n            'total': sum(aging_buckets.values())\n        })\n    \n    return report\n```\n\n### 3.2. Dự Báo Dòng Tiền\n```python\ndef du_bao_dong_tien(entity_model, from_date, to_date):\n    \"\"\"\n    Dự báo dòng tiền theo tuần\n    \"\"\"\n    # Thu từ khách hàng\n    invoices = InvoiceModel.objects.filter(\n        entity=entity_model,\n        due_date__range=[from_date, to_date],\n        status='unpaid'\n    )\n    \n    # Chi trả nhà cung cấp\n    bills = BillModel.objects.filter(\n        entity=entity_model,\n        due_date__range=[from_date, to_date],\n        status='unpaid'\n    )\n    \n    # Chi trả lương\n    payroll = PayrollModel.objects.filter(\n        entity=entity_model,\n        payment_date__range=[from_date, to_date]\n    )\n    \n    # Chi trả thuế\n    tax_payments = TaxPaymentModel.objects.filter(\n        entity=entity_model,\n        due_date__range=[from_date, to_date]\n    )\n    \n    # Tổng hợp theo tuần\n    weeks = []\n    current_date = from_date\n    while current_date \u003c= to_date:\n        week_end = current_date + timedelta(days=6)\n        \n        week_data = {\n            'from_date': current_date,\n            'to_date': week_end,\n            'inflows': {\n                'customer_payments': sum(\n                    inv.amount_due for inv in invoices\n                    if current_date \u003c= inv.due_date \u003c= week_end\n                )\n            },\n            'outflows': {\n                'vendor_payments': sum(\n                    bill.amount_due for bill in bills\n                    if current_date \u003c= bill.due_date \u003c= week_end\n                ),\n                'payroll': sum(\n                    pay.amount for pay in payroll\n                    if current_date \u003c= pay.payment_date \u003c= week_end\n                ),\n                'tax_payments': sum(\n                    tax.amount for tax in tax_payments\n                    if current_date \u003c= tax.due_date \u003c= week_end\n                )\n            }\n        }\n        \n        week_data['net_cash_flow'] = (\n            sum(week_data['inflows'].values()) -\n            sum(week_data['outflows'].values())\n        )\n        \n        weeks.append(week_data)\n        current_date += timedelta(days=7)\n        \n    return weeks\n```\n\n### 3.3. Báo Cáo Thanh Toán\n```python\ndef bao_cao_trang_thai_thanh_toan(entity_model, from_date, to_date):\n    \"\"\"\n    Báo cáo trạng thái thanh toán\n    \"\"\"\n    payment_requests = PaymentRequestModel.objects.filter(\n        entity=entity_model,\n        created_at__range=[from_date, to_date]\n    )\n    \n    # Thống kê theo trạng thái\n    stats = {\n        'draft': {'count': 0, 'amount': Decimal('0')},\n        'pending_approval': {'count': 0, 'amount': Decimal('0')},\n        'approved': {'count': 0, 'amount': Decimal('0')},\n        'rejected': {'count': 0, 'amount': Decimal('0')},\n        'completed': {'count': 0, 'amount': Decimal('0')}\n    }\n    \n    for pr in payment_requests:\n        stats[pr.status]['count'] += 1\n        stats[pr.status]['amount'] += pr.amount\n        \n    # Thống kê theo phương thức\n    by_method = {\n        'cash': {'count': 0, 'amount': Decimal('0')},\n        'bank_transfer': {'count': 0, 'amount': Decimal('0')},\n        'check': {'count': 0, 'amount': Decimal('0')}\n    }\n    \n    for pr in payment_requests:\n        by_method[pr.payment_method]['count'] += 1\n        by_method[pr.payment_method]['amount'] += pr.amount\n        \n    return {\n        'by_status': stats,\n        'by_method': by_method,\n        'total_count': payment_requests.count(),\n        'total_amount': sum(pr.amount for pr in payment_requests)\n    }\n"])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/bank_reconciliation\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/bank_reconciliation/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/bank_reconciliation\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"bank_reconciliation\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/bank_reconciliation\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>