<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T5975,"])</script><script>self.__next_f.push([1,"# GEO_005_Geography_Quản Lý Khu Vực\n\n*Phiên bản: 1.0*\n*Người tạo: Cline*\n*Ngày tạo: 13/05/2025*\n*Cập nhật lần cuối: 13/05/2025*\n*Người cập nhật: Cline*\n\n## 1. Tổng Quan Nghiệp Vụ\n\n### 1.1. Mô Tả Nghiệp Vụ\nNghiệp vụ này cho phép quản lý thông tin các khu vực địa lý (ví dụ: Miền Bắc, Miền Trung, Miền Nam) trong hệ thống ERP. Mỗi khu vực thuộc một quốc gia và có thể bao gồm nhiều tỉnh thành. Bao gồm việc tạo mới, xem, cập nhật và xóa thông tin khu vực. Thông tin khu vực giúp phân vùng địa lý ở cấp độ cao hơn tỉnh thành, phục vụ cho mục đích phân tích, báo cáo, và quản lý kinh doanh theo vùng.\n\n### 1.2. Phạm Vi Áp Dụng\nÁp dụng cho các bộ phận cần phân tích dữ liệu theo vùng địa lý lớn, bao gồm bộ phận kinh doanh, marketing, kế hoạch. Người dùng có quyền quản trị hệ thống hoặc được phân quyền cụ thể mới có thể thực hiện các thao tác quản lý khu vực.\n\n### 1.3. Định Nghĩa Thuật Ngữ\n| Thuật ngữ | Định nghĩa |\n|-----------|------------|\n| Mã Khu Vực (ma_kv) | Mã định danh duy nhất cho mỗi khu vực trong một quốc gia. |\n| Tên Khu Vực (ten_kv) | Tên chính thức của khu vực. |\n| Tên Khu Vực Khác (ten_kv2) | Tên thay thế hoặc tên tiếng Anh của khu vực. |\n| Quốc Gia (quoc_gia) | Quốc gia mà khu vực này trực thuộc. |\n| Trạng Thái (status) | Trạng thái của khu vực (ví dụ: 1 - Hoạt động, 0 - Không hoạt động). |\n| Entity (Đơn vị) | Đơn vị/Công ty sử dụng hệ thống ERP. Mỗi khu vực được quản lý trong phạm vi một Entity cụ thể. |\n\n### 1.4. Tài Liệu Liên Quan\n| STT | Mã tài liệu | Tên tài liệu | Mô tả |\n|-----|-------------|--------------|-------|\n| 1   | GEO_001 | Quản Lý Quốc Gia | Tài liệu mô tả quy trình quản lý thông tin quốc gia, là cấp cha của khu vực. |\n| 2   | GEO_002 | Quản Lý Tỉnh Thành | Tài liệu mô tả quy trình quản lý thông tin tỉnh thành. Tỉnh thành có thể được nhóm theo khu vực. |\n| 3   | RPT_XXX | Báo cáo theo Khu Vực | (Ví dụ) Các báo cáo có thể sử dụng thông tin khu vực để tổng hợp dữ liệu. |\n\n## 2. Quy Trình Nghiệp Vụ\n\n### 2.1. Tổng Quan Quy Trình\nQuy trình quản lý khu vực bao gồm các bước: người dùng yêu cầu thực hiện thao tác (thêm, sửa, xóa, xem danh sách, xem chi tiết), hệ thống kiểm tra dữ liệu và quyền hạn, sau đó thực thi yêu cầu và phản hồi kết quả cho người dùng.\n\n### 2.2. Sơ Đồ Quy Trình (Business Flow)\n\n```mermaid\nflowchart TD\n    A[Người dùng yêu cầu thao tác quản lý khu vực] --\u003e B{Chọn thao tác};\n    B --\u003e|Thêm mới| C[Nhập thông tin khu vực (bao gồm chọn Quốc Gia)];\n    B --\u003e|Cập nhật| D[Chọn khu vực \u0026 Nhập thông tin mới];\n    B --\u003e|Xóa| E[Chọn khu vực \u0026 Xác nhận xóa];\n    B --\u003e|Xem danh sách| F[Hệ thống hiển thị danh sách khu vực (có thể lọc theo Quốc Gia)];\n    B --\u003e|Xem chi tiết| G[Chọn khu vực \u0026 Hệ thống hiển thị chi tiết];\n    C --\u003e H[Hệ thống kiểm tra dữ liệu];\n    D --\u003e H;\n    H --\u003e|Hợp lệ| I[Lưu thông tin vào CSDL];\n    H --\u003e|Không hợp lệ| J[Thông báo lỗi];\n    I --\u003e K[Thông báo thành công];\n    E --\u003e L[Hệ thống kiểm tra ràng buộc (ví dụ: Tỉnh Thành đang tham chiếu)];\n    L --\u003e|Không có ràng buộc| M[Xóa khu vực khỏi CSDL];\n    L --\u003e|Có ràng buộc| N[Thông báo lỗi không thể xóa];\n    M --\u003e K;\n    F --\u003e Z[Kết thúc];\n    G --\u003e Z;\n    J --\u003e A;\n    K --\u003e A;\n    N --\u003e A;\n```\n\n### 2.3. Chi Tiết Các Bước Quy Trình\n\n#### 2.3.1. Thêm Mới Khu Vực\n- **Mô tả**: Người dùng cung cấp thông tin để tạo một khu vực mới, liên kết với một quốc gia cụ thể.\n- **Đầu vào**: Mã khu vực, tên khu vực, tên khu vực khác (tùy chọn), UUID của quốc gia, trạng thái (mặc định là hoạt động).\n- **Đầu ra**: Khu vực mới được tạo trong hệ thống.\n- **Người thực hiện**: Quản trị viên hệ thống hoặc người dùng được phân quyền.\n- **Điều kiện tiên quyết**: Người dùng đã đăng nhập và có quyền. Quốc gia liên kết phải tồn tại. Mã khu vực không được trùng lặp trong cùng một quốc gia và Entity.\n- **Xử lý ngoại lệ**:\n    - Nếu mã khu vực đã tồn tại trong quốc gia đó: Thông báo lỗi.\n    - Nếu quốc gia không tồn tại: Thông báo lỗi.\n    - Nếu thông tin không hợp lệ: Thông báo lỗi.\n\n#### 2.3.2. Cập Nhật Thông Tin Khu Vực\n- **Mô tả**: Người dùng thay đổi thông tin của một khu vực đã tồn tại.\n- **Đầu vào**: UUID của khu vực cần cập nhật, thông tin mới (mã khu vực, tên khu vực, tên khu vực khác, UUID quốc gia, trạng thái).\n- **Đầu ra**: Thông tin khu vực được cập nhật trong hệ thống.\n- **Người thực hiện**: Quản trị viên hệ thống hoặc người dùng được phân quyền.\n- **Điều kiện tiên quyết**: Khu vực tồn tại trong hệ thống. Người dùng có quyền cập nhật.\n- **Xử lý ngoại lệ**:\n    - Nếu khu vực không tồn tại: Thông báo lỗi.\n    - Nếu mã khu vực mới (nếu thay đổi) đã tồn tại cho một khu vực khác trong cùng quốc gia: Thông báo lỗi.\n    - Nếu thông tin không hợp lệ: Thông báo lỗi.\n\n#### 2.3.3. Xóa Khu Vực\n- **Mô tả**: Người dùng xóa một khu vực khỏi hệ thống.\n- **Đầu vào**: UUID của khu vực cần xóa.\n- **Đầu ra**: Khu vực bị xóa khỏi hệ thống (nếu không có ràng buộc).\n- **Người thực hiện**: Quản trị viên hệ thống hoặc người dùng được phân quyền.\n- **Điều kiện tiên quyết**: Khu vực tồn tại trong hệ thống. Người dùng có quyền xóa.\n- **Xử lý ngoại lệ**:\n    - Nếu khu vực không tồn tại: Thông báo lỗi.\n    - Nếu khu vực đang được sử dụng (ví dụ: có tỉnh thành liên kết): Thông báo lỗi không thể xóa (hoặc yêu cầu bỏ liên kết tỉnh thành trước).\n\n#### 2.3.4. Xem Danh Sách Khu Vực\n- **Mô tả**: Người dùng xem danh sách các khu vực, có thể lọc theo quốc gia, và phân trang.\n- **Đầu vào**: Entity slug, tùy chọn: UUID quốc gia, trang, kích thước trang, các tiêu chí lọc (tên, mã).\n- **Đầu ra**: Danh sách các khu vực thỏa mãn điều kiện.\n- **Người thực hiện**: Bất kỳ người dùng nào có quyền truy cập chức năng.\n- **Điều kiện tiên quyết**: Người dùng đã đăng nhập.\n\n#### 2.3.5. Xem Chi Tiết Khu Vực\n- **Mô tả**: Người dùng xem thông tin chi tiết của một khu vực cụ thể.\n- **Đầu vào**: UUID của khu vực.\n- **Đầu ra**: Thông tin chi tiết của khu vực.\n- **Người thực hiện**: Bất kỳ người dùng nào có quyền truy cập chức năng.\n- **Điều kiện tiên quyết**: Khu vực tồn tại trong hệ thống.\n- **Xử lý ngoại lệ**: Nếu khu vực không tồn tại: Thông báo lỗi.\n\n### 2.4. Sơ Đồ Tuần Tự (Sequence Diagram) - Thêm Mới Khu Vực\n\n```mermaid\nsequenceDiagram\n    participant User as Người dùng\n    participant System as Hệ thống (API)\n    participant Service as KhuVucModelService\n    participant Repository as KhuVucRepository\n    participant QuocGiaRepo as QuocGiaRepository\n    participant DB as Cơ sở dữ liệu\n\n    User-\u003e\u003eSystem: POST /api/{entity_slug}/khu-vuc/ (data: ma_kv, ten_kv, quoc_gia_uuid, ...)\n    System-\u003e\u003eService: create_khu_vuc(entity_slug, data)\n    Service-\u003e\u003eService: _get_entity_model(entity_slug)\n    Service--\u003e\u003eService: entity_model\n    Service-\u003e\u003eQuocGiaRepo: get_quoc_gia_by_uuid(data['quoc_gia_uuid'])\n    QuocGiaRepo-\u003e\u003eDB: SELECT * FROM QuocGiaModel WHERE uuid = ...\n    DB--\u003e\u003eQuocGiaRepo: quoc_gia_model (or null)\n    QuocGiaRepo--\u003e\u003eService: quoc_gia_model (or null)\n    alt Quốc gia không tồn tại\n        Service--\u003e\u003eSystem: Error: \"Country not found\"\n        System--\u003e\u003eUser: Response 400 (Error message)\n    else Quốc gia tồn tại\n        Service-\u003e\u003eService: validate_khu_vuc_data(data)\n        Service--\u003e\u003eService: validated_data\n        Service-\u003e\u003eRepository: get_khu_vuc_by_code(entity_model, quoc_gia_model, validated_data['ma_kv'])\n        Repository-\u003e\u003eDB: SELECT * FROM KhuVucModel WHERE entity_id = ... AND quoc_gia_id = ... AND ma_kv = ...\n        DB--\u003e\u003eRepository: existing_khu_vuc (or null)\n        Repository--\u003e\u003eService: existing_khu_vuc (or null)\n        alt Mã khu vực đã tồn tại trong quốc gia\n            Service--\u003e\u003eSystem: Error: \"Region code already exists in this country\"\n            System--\u003e\u003eUser: Response 400 (Error message)\n        else Mã khu vực chưa tồn tại\n            Service-\u003e\u003eRepository: create_khu_vuc(validated_data_with_entity_and_country)\n            Repository-\u003e\u003eDB: INSERT INTO KhuVucModel (...) VALUES (...)\n            DB--\u003e\u003eRepository: new_khu_vuc_object\n            Repository--\u003e\u003eService: new_khu_vuc_object\n            Service--\u003e\u003eSystem: new_khu_vuc_object\n            System--\u003e\u003eUser: Response 201 (new_khu_vuc_data)\n        end\n    end\n```\n\n### 2.5. Luồng Nghiệp Vụ Thay Thế\n- **Tìm kiếm khu vực**: Người dùng có thể tìm kiếm khu vực theo tên hoặc theo mã.\n- **Lọc khu vực theo quốc gia**: Người dùng có thể xem danh sách khu vực thuộc một quốc gia cụ thể.\n- **Quản lý Tỉnh Thành thuộc Khu Vực**: Chức năng riêng để gán/bỏ gán Tỉnh Thành vào một Khu Vực (có thể thực hiện từ màn hình quản lý Tỉnh Thành hoặc Khu Vực).\n\n## 3. Yêu Cầu Chức Năng\n\n### 3.1. Danh Sách Chức Năng\n\n| STT | Mã chức năng | Tên chức năng | Mô tả | Độ ưu tiên |\n|-----|--------------|---------------|-------|------------|\n| 1   | GEO_005_F01 | Thêm mới khu vực | Cho phép tạo một khu vực mới, thuộc một quốc gia. | Cao |\n| 2   | GEO_005_F02 | Cập nhật khu vực | Cho phép sửa thông tin của một khu vực đã có. | Cao |\n| 3   | GEO_005_F03 | Xóa khu vực | Cho phép xóa một khu vực khỏi hệ thống. | Cao |\n| 4   | GEO_005_F04 | Xem danh sách khu vực | Hiển thị danh sách các khu vực, hỗ trợ phân trang và lọc (theo quốc gia, tên, mã). | Cao |\n| 5   | GEO_005_F05 | Xem chi tiết khu vực | Hiển thị thông tin chi tiết của một khu vực. | Cao |\n| 6   | GEO_005_F06 | Tìm kiếm khu vực theo tên | Cho phép tìm kiếm khu vực dựa trên tên. | Trung bình |\n| 7   | GEO_005_F07 | Tìm kiếm khu vực theo mã | Cho phép tìm kiếm khu vực dựa trên mã. | Trung bình |\n| 8   | GEO_005_F08 | Lấy danh sách khu vực đang hoạt động | Lấy danh sách các khu vực có trạng thái là \"Hoạt động\". | Trung bình |\n| 9   | GEO_005_F09 | Lấy danh sách khu vực theo quốc gia | Lấy danh sách các khu vực thuộc một quốc gia cụ thể. | Cao |\n| 10  | GEO_005_F10 | Xem danh sách Tỉnh Thành thuộc Khu Vực | Hiển thị danh sách các Tỉnh Thành được gán cho một Khu Vực. | Trung bình |\n\n### 3.2. Chi Tiết Chức Năng\n\n#### 3.2.1. GEO_005_F01: Thêm mới khu vực\n- **Mô tả**: Chức năng cho phép người dùng tạo mới một khu vực.\n- **Đầu vào**:\n    - `entity_slug`: Slug của Entity.\n    - `data`: Đối tượng chứa thông tin khu vực:\n        - `ma_kv` (bắt buộc): Mã khu vực (string, max 100).\n        - `ten_kv` (bắt buộc): Tên khu vực (string, max 255).\n        - `ten_kv2` (tùy chọn): Tên khu vực khác (string, max 255).\n        - `quoc_gia_uuid` (bắt buộc): UUID của Quốc Gia.\n        - `status` (tùy chọn): Trạng thái (integer). Mặc định là 1.\n- **Đầu ra**: Đối tượng KhuVucModel vừa được tạo.\n- **Điều kiện tiên quyết**: `entity_slug` và `quoc_gia_uuid` hợp lệ. `ma_kv` không trùng trong cùng `entity_slug` và `quoc_gia_uuid`.\n- **Luồng xử lý chính**:\n  1. Service lấy `EntityModel` và `QuocGiaModel`.\n  2. Service validate dữ liệu (`ma_kv`, `ten_kv`, `quoc_gia_uuid`).\n  3. Service kiểm tra `ma_kv` đã tồn tại trong `Entity` và `QuocGia` chưa.\n  4. Nếu chưa, Service gọi Repository để tạo mới.\n- **Giao diện liên quan**: Form thêm mới khu vực.\n\n#### 3.2.2. GEO_005_F02: Cập nhật khu vực\n- **Mô tả**: Cập nhật thông tin khu vực.\n- **Đầu vào**:\n    - `entity_slug`: Slug của Entity.\n    - `uuid`: UUID của khu vực.\n    - `data`: Thông tin cập nhật (tương tự thêm mới, các trường tùy chọn).\n- **Đầu ra**: Đối tượng KhuVucModel đã cập nhật.\n- **Điều kiện tiên quyết**: Khu vực tồn tại. Nếu `ma_kv` hoặc `quoc_gia_uuid` thay đổi, mã mới không được trùng.\n- **Giao diện liên quan**: Form cập nhật khu vực.\n\n#### 3.2.3. GEO_005_F03: Xóa khu vực\n- **Mô tả**: Xóa một khu vực.\n- **Đầu vào**: `entity_slug`, `uuid` của khu vực.\n- **Đầu ra**: HTTP 204 No Content.\n- **Điều kiện tiên quyết**: Khu vực tồn tại và không có Tỉnh Thành nào đang tham chiếu đến.\n- **Giao diện liên quan**: Nút xóa.\n\n#### 3.2.4. GEO_005_F04: Xem danh sách khu vực\n- **Mô tả**: Lấy danh sách khu vực, có phân trang và lọc.\n- **Đầu vào**: `entity_slug`, `page`, `page_size`, `quoc_gia_uuid` (lọc), `ma_kv`, `ten_kv`.\n- **Đầu ra**: Danh sách KhuVucModel.\n- **Giao diện liên quan**: Trang danh sách khu vực.\n\n#### 3.2.5. GEO_005_F05: Xem chi tiết khu vực\n- **Mô tả**: Lấy chi tiết một khu vực.\n- **Đầu vào**: `entity_slug`, `uuid` của khu vực.\n- **Đầu ra**: Đối tượng KhuVucModel (có thể kèm danh sách Tỉnh Thành thuộc khu vực).\n- **Giao diện liên quan**: Trang chi tiết khu vực.\n\n#### 3.2.9. GEO_005_F09: Lấy danh sách khu vực theo quốc gia\n- **Mô tả**: Lấy danh sách các khu vực thuộc một quốc gia cụ thể.\n- **Đầu vào**: `entity_slug`, `quoc_gia_uuid`.\n- **Đầu ra**: `QuerySet` các `KhuVucModel`.\n\n#### 3.2.10. GEO_005_F10: Xem danh sách Tỉnh Thành thuộc Khu Vực\n- **Mô tả**: Lấy danh sách các Tỉnh Thành được gán cho một Khu Vực cụ thể.\n- **Đầu vào**: `entity_slug`, `khu_vuc_uuid`.\n- **Đầu ra**: Danh sách `TinhThanhModel`.\n- **Giao diện liên quan**: Tab/Phần trong trang chi tiết Khu Vực.\n\n## 4. Thiết Kế Kỹ Thuật\n\n### 4.1. Kiến Trúc Hệ Thống\nSử dụng Views/APIs, Services (`KhuVucModelService`), Repositories (`KhuVucRepository`), Models (`KhuVucModel`, `QuocGiaModel`, `TinhThanhModel`, `EntityModel`).\n\n### 4.2. API Endpoints\n\n- **Base URL**: `/api/{entity_slug}/khu-vuc/`\n- **Endpoints**:\n    - `GET /`: Lấy danh sách khu vực. (GEO_005_F04)\n        - Query params: `page`, `page_size`, `quoc_gia_uuid`, `ma_kv`, `ten_kv`, `status`.\n    - `POST /`: Tạo mới khu vực. (GEO_005_F01)\n        - Request body: `{ \"ma_kv\": \"MB\", \"ten_kv\": \"Miền Bắc\", \"quoc_gia_uuid\": \"uuid_cua_VN\", \"status\": 1 }`\n    - `GET /{uuid}/`: Lấy chi tiết khu vực. (GEO_005_F05)\n    - `PUT /{uuid}/`: Cập nhật khu vực. (GEO_005_F02)\n    - `PATCH /{uuid}/`: Cập nhật một phần khu vực. (GEO_005_F02)\n    - `DELETE /{uuid}/`: Xóa khu vực. (GEO_005_F03)\n    - `GET /theo-quoc-gia/{quoc_gia_uuid}/`: Lấy khu vực theo quốc gia. (GEO_005_F09)\n    - `GET /{uuid}/tinh-thanh/`: Lấy danh sách tỉnh thành thuộc khu vực. (GEO_005_F10)\n\n### 4.3. Service Logic (`KhuVucModelService`)\n- Tương tự `TinhThanhModelService` nhưng cho `KhuVucModel`.\n- Kiểm tra sự tồn tại của `QuocGiaModel` khi tạo/cập nhật.\n- Validate `ma_kv` phải duy nhất trong phạm vi `Entity` và `QuocGia`.\n- Logic lấy danh sách Tỉnh Thành theo `khu_vuc_uuid`.\n\n### 4.4. Mô Hình Dữ Liệu\n\n#### 4.4.1. Entity Relationship Diagram (ERD)\n\n```mermaid\nerDiagram\n    ENTITY ||--|{ QUOC_GIA : \"quản lý\"\n    ENTITY ||--|{ KHU_VUC : \"quản lý\"\n    ENTITY ||--|{ TINH_THANH : \"quản lý\"\n    ENTITY ||--|{ QUAN_HUYEN : \"quản lý\"\n    ENTITY ||--|{ XA_PHUONG : \"quản lý\"\n\n    QUOC_GIA ||--o{ KHU_VUC : \"có\"\n    QUOC_GIA ||--o{ TINH_THANH : \"có\"\n    KHU_VUC ||--o{ TINH_THANH : \"nhóm (tùy chọn)\"\n    TINH_THANH ||--o{ QUAN_HUYEN : \"có\"\n    QUAN_HUYEN ||--o{ XA_PHUONG : \"có\"\n\n    ENTITY {\n        uuid uuid PK\n        string slug\n        string name\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    QUOC_GIA {\n        uuid uuid PK\n        string ma_qg\n        string ten_qg\n        uuid entity_id FK\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    KHU_VUC {\n        uuid uuid PK\n        string ma_kv \"Mã khu vực (duy nhất trong Quốc Gia \u0026 Entity)\"\n        string ten_kv \"Tên khu vực\"\n        string ten_kv2 \"Tên khu vực khác\"\n        integer status \"Trạng thái\"\n        datetime created\n        datetime updated\n        uuid entity_id FK \"Khóa ngoại tới ENTITY\"\n        uuid quoc_gia_id FK \"Khóa ngoại tới QUOC_GIA\"\n    }\n\n    TINH_THANH {\n        uuid uuid PK\n        string ma_tinh\n        string ten_tinh\n        uuid quoc_gia_id FK \"Khóa ngoại tới QUOC_GIA\"\n        uuid khu_vuc_id FK \"Khóa ngoại tới KHU_VUC (tùy chọn)\"\n        uuid entity_id FK \"Khóa ngoại tới ENTITY\"\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    QUAN_HUYEN {\n        uuid uuid PK\n        string ma_huyen\n        string ten_huyen\n        uuid tinh_thanh_id FK\n        uuid entity_id FK\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    XA_PHUONG {\n        uuid uuid PK\n        string ma_xa\n        string ten_xa\n        uuid quan_huyen_id FK\n        uuid entity_id FK\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n```\n\n#### 4.4.2. Chi Tiết Bảng Dữ Liệu\n\n##### Bảng: `KhuVucModel` (django_ledger_khuvucmodel)\n- **Mô tả**: Lưu trữ thông tin các khu vực.\n- **Các cột chính**:\n    - `uuid` (UUID, Khóa chính).\n    - `ma_kv` (CharField, max_length=100).\n    - `ten_kv` (CharField, max_length=255).\n    - `ten_kv2` (CharField, max_length=255, null=True, blank=True).\n    - `status` (IntegerField, default=1).\n    - `entity_model` (ForeignKey đến `EntityModel`).\n    - `quoc_gia` (ForeignKey đến `QuocGiaModel`).\n    - `created` (DateTimeField, auto_now_add=True).\n    - `updated` (DateTimeField, auto_now=True).\n- **Indexes**:\n    - `unique_together = ('entity_model', 'quoc_gia', 'ma_kv')`.\n\n##### Bảng: `TinhThanhModel` (django_ledger_tinhthanhmodel) - Cập nhật\n- Thêm cột:\n    - `khu_vuc` (ForeignKey đến `KhuVucModel`, null=True, blank=True, on_delete=models.SET_NULL).\n\n## 5. Kế Hoạch Kiểm Thử\n\n### 5.1. Phạm Vi Kiểm Thử\n- CRUD cho Khu Vực.\n- Lọc theo Quốc Gia.\n- Validation dữ liệu (bao gồm `quoc_gia_uuid`).\n- Ràng buộc duy nhất của `ma_kv` theo `entity_model` và `quoc_gia`.\n- Liên kết Tỉnh Thành với Khu Vực (cập nhật Tỉnh Thành để gán `khu_vuc_id`).\n- Xóa Khu Vực (kiểm tra ràng buộc với Tỉnh Thành).\n\n### 5.2. Kịch Bản Kiểm Thử (Ví dụ)\n\n| STT | Mã kịch bản | Tên kịch bản | Mô tả | Điều kiện tiên quyết | Các bước | Kết quả mong đợi |\n|-----|------------|--------------|-------|---------------------|----------|-----------------|\n| 1   | GEO_005_TC01 | Thêm mới khu vực thành công | Kiểm tra thêm khu vực với dữ liệu hợp lệ. | User đăng nhập, có quyền. Entity \"E1\", Quốc gia \"VN\" (uuid_vn) tồn tại. | 1. POST `/api/E1/khu-vuc/`. 2. Payload: `{\"ma_kv\": \"MB\", \"ten_kv\": \"Miền Bắc\", \"quoc_gia_uuid\": \"uuid_vn\"}`. | 1. HTTP 201. 2. Dữ liệu khu vực được trả về. 3. Khu vực được lưu vào CSDL. |\n| 2   | GEO_005_TC02 | Thêm mới khu vực với mã trùng | Kiểm tra thêm khu vực có `ma_kv` đã tồn tại trong cùng Quốc gia \u0026 Entity. | Như TC01. Khu vực \"MB\" thuộc \"VN\" đã tồn tại. | 1. POST `/api/E1/khu-vuc/`. 2. Payload: `{\"ma_kv\": \"MB\", \"ten_kv\": \"Khu Vực Miền Bắc\", \"quoc_gia_uuid\": \"uuid_vn\"}`. | 1. HTTP 400. 2. Lỗi \"Region code already exists in this country\". |\n| 3   | GEO_005_TC03 | Thêm mới khu vực với quốc gia không tồn tại | Kiểm tra thêm khu vực với `quoc_gia_uuid` không tồn tại. | Như TC01. `invalid_uuid_qg` không tồn tại. | 1. POST `/api/E1/khu-vuc/`. 2. Payload: `{\"ma_kv\": \"MT\", \"ten_kv\": \"Miền Trung\", \"quoc_gia_uuid\": \"invalid_uuid_qg\"}`. | 1. HTTP 400. 2. Lỗi \"Country not found\". |\n| 4   | GEO_005_TC04 | Xem danh sách khu vực theo quốc gia | Lấy danh sách khu vực của quốc gia \"VN\". | Như TC01. Có khu vực \"MB\" và \"MN\" thuộc \"VN\". | 1. GET `/api/E1/khu-vuc/?quoc_gia_uuid=uuid_vn`. | 1. HTTP 200. 2. Danh sách chứa \"MB\" và \"MN\". |\n| 5   | GEO_005_TC05 | Gán Tỉnh Thành cho Khu Vực | Cập nhật Tỉnh Thành \"HN\" để thuộc Khu Vực \"MB\". | Entity \"E1\", Quốc gia \"VN\", Tỉnh Thành \"HN\" (uuid_hn), Khu Vực \"MB\" (uuid_mb) tồn tại. | 1. PATCH `/api/E1/tinh-thanh/uuid_hn/`. 2. Payload: `{\"khu_vuc_uuid\": \"uuid_mb\"}`. | 1. HTTP 200. 2. Tỉnh Thành \"HN\" có `khu_vuc_id` là `uuid_mb`. |\n| 6   | GEO_005_TC06 | Xem Tỉnh Thành thuộc Khu Vực | Lấy danh sách Tỉnh Thành thuộc Khu Vực \"MB\". | Như TC05. \"HN\" thuộc \"MB\". | 1. GET `/api/E1/khu-vuc/uuid_mb/tinh-thanh/`. | 1. HTTP 200. 2. Danh sách chứa Tỉnh Thành \"HN\". |\n| 7   | GEO_005_TC07 | Xóa Khu Vực có Tỉnh Thành liên kết | Cố gắng xóa Khu Vực \"MB\" khi \"HN\" đang liên kết. | Như TC06. | 1. DELETE `/api/E1/khu-vuc/uuid_mb/`. | 1. HTTP 400. 2. Lỗi thông báo không thể xóa do có Tỉnh Thành liên kết. |\n\n## 6. Phụ Lục\n\n### 6.1. Danh Sách Tài Liệu Tham Khảo\n- Mã nguồn Django Ledger: `django_ledger/services/khu_vuc/khu_vuc.py` (dự kiến)\n- Mã nguồn Django Ledger: `django_ledger/repositories/khu_vuc/khu_vuc.py` (dự kiến)\n- Mã nguồn Django Ledger: `django_ledger/models/khu_vuc.py` (dự kiến)\n- Mã nguồn Django Ledger: `django_ledger/models/tinh_thanh.py` (cập nhật)\n\n### 6.2. Danh Mục Thuật Ngữ\n(Đã định nghĩa ở mục 1.3)\n\n### 6.3. Lịch Sử Thay Đổi Tài Liệu\n\n| Phiên bản | Ngày | Người thực hiện | Mô tả thay đổi |\n|-----------|------|-----------------|---------------|\n| 1.0 | 13/05/2025 | Cline | Tạo mới tài liệu. |\n"])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/GEO_005_Quan_Ly_Khu_Vuc\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/GEO_005_Quan_Ly_Khu_Vuc/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/GEO_005_Quan_Ly_Khu_Vuc\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"GEO_005_Quan_Ly_Khu_Vuc\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/GEO_005_Quan_Ly_Khu_Vuc\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>