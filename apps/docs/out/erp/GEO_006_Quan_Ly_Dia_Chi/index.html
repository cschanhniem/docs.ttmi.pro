<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T5a7e,"])</script><script>self.__next_f.push([1,"# GEO_006_Geography_Quản Lý Địa Chỉ\n\n*Phiên bản: 1.0*\n*Người tạo: Cline*\n*Ngày tạo: 13/05/2025*\n*Cập nhật lần cuối: 13/05/2025*\n*Người cập nhật: Cline*\n\n## 1. Tổng Quan Nghiệp Vụ\n\n### 1.1. Mô Tả Nghiệp Vụ\nNghiệp vụ này cho phép quản lý thông tin địa chỉ chi tiết trong hệ thống ERP. Một địa chỉ đầy đủ bao gồm thông tin số nhà, đường phố, xã/phường, quận/huyện, tỉnh/thành phố, và quốc gia. Nó cũng có thể bao gồm mã bưu điện, tọa độ địa lý (kinh độ, vĩ độ) và các ghi chú liên quan. Địa chỉ là thông tin cơ bản được sử dụng rộng rãi trong nhiều phân hệ như quản lý khách hàng, nhà cung cấp, giao vận, nhân sự, v.v.\n\n### 1.2. Phạm Vi Áp Dụng\nÁp dụng cho tất cả các bộ phận và quy trình nghiệp vụ cần sử dụng hoặc lưu trữ thông tin địa chỉ. Người dùng có quyền quản trị hệ thống hoặc được phân quyền cụ thể mới có thể thực hiện các thao tác quản lý trực tiếp danh mục địa chỉ gốc (nếu có). Thông thường, địa chỉ sẽ được tạo và quản lý trong ngữ cảnh của một đối tượng cụ thể (ví dụ: địa chỉ khách hàng).\n\n### 1.3. Định Nghĩa Thuật Ngữ\n| Thuật ngữ | Định nghĩa |\n|-----------|------------|\n| Địa Chỉ Đầy Đủ (dia_chi_day_du) | Chuỗi văn bản mô tả đầy đủ địa chỉ, thường được hệ thống tự động ghép từ các thành phần. |\n| Số Nhà, Đường Phố (so_nha_duong_pho) | Thông tin chi tiết về số nhà và tên đường. |\n| Xã/Phường (xa_phuong) | Xã/phường mà địa chỉ này thuộc về. Liên kết tới `XaPhuongModel`. |\n| Quận/Huyện (quan_huyen) | Quận/huyện mà địa chỉ này thuộc về (thông qua `XaPhuongModel`). |\n| Tỉnh/Thành Phố (tinh_thanh) | Tỉnh/thành phố mà địa chỉ này thuộc về (thông qua `XaPhuongModel`). |\n| Quốc Gia (quoc_gia) | Quốc gia mà địa chỉ này thuộc về (thông qua `XaPhuongModel`). |\n| Khu Vực (khu_vuc) | Khu vực địa lý mà địa chỉ này có thể thuộc về (thông qua `TinhThanhModel`, tùy chọn). |\n| Mã Bưu Điện (ma_buu_dien) | Mã bưu chính của địa chỉ (tùy chọn). |\n| Kinh Độ (kinh_do) | Tọa độ kinh độ của địa chỉ (tùy chọn). |\n| Vĩ Độ (vi_do) | Tọa độ vĩ độ của địa chỉ (tùy chọn). |\n| Ghi Chú (ghi_chu) | Thông tin bổ sung về địa chỉ. |\n| Trạng Thái (status) | Trạng thái của địa chỉ (ví dụ: 1 - Hoạt động, 0 - Không hoạt động). |\n| Entity (Đơn vị) | Đơn vị/Công ty sử dụng hệ thống ERP. Mỗi địa chỉ được quản lý trong phạm vi một Entity cụ thể. |\n\n### 1.4. Tài Liệu Liên Quan\n| STT | Mã tài liệu | Tên tài liệu | Mô tả |\n|-----|-------------|--------------|-------|\n| 1   | GEO_001 | Quản Lý Quốc Gia | Cung cấp thông tin Quốc Gia. |\n| 2   | GEO_002 | Quản Lý Tỉnh Thành | Cung cấp thông tin Tỉnh Thành. |\n| 3   | GEO_003 | Quản Lý Quận Huyện | Cung cấp thông tin Quận Huyện. |\n| 4   | GEO_004 | Quản Lý Xã Phường | Cung cấp thông tin Xã Phường, là thành phần cơ sở của Địa Chỉ. |\n| 5   | GEO_005 | Quản Lý Khu Vực | Cung cấp thông tin Khu Vực (tùy chọn). |\n| 6   | SAL_001 | Quản Lý Khách Hàng | Khách hàng có thể có nhiều địa chỉ. |\n| 7   | PUR_001 | Quản Lý Nhà Cung Cấp | Nhà cung cấp có thể có nhiều địa chỉ. |\n| 8   | GEO_007 | Quản Lý Địa Chỉ Nhận Hàng | Chuyên biệt hóa quản lý địa chỉ cho mục đích giao nhận. |\n\n## 2. Quy Trình Nghiệp Vụ\n\n### 2.1. Tổng Quan Quy Trình\nQuy trình quản lý địa chỉ bao gồm việc tạo mới một địa chỉ bằng cách cung cấp các thành phần chi tiết (số nhà, đường phố, chọn xã/phường), xem, cập nhật và xóa (logic) địa chỉ. Hệ thống sẽ tự động tổng hợp thông tin quận/huyện, tỉnh/thành, quốc gia từ xã/phường được chọn.\n\n### 2.2. Sơ Đồ Quy Trình (Business Flow)\n\n```mermaid\nflowchart TD\n    A[Người dùng yêu cầu thao tác quản lý địa chỉ] --\u003e B{Chọn thao tác};\n    B --\u003e|Thêm mới| C[Nhập thông tin địa chỉ (Số nhà, đường, chọn Xã/Phường, Mã bưu điện, ...)];\n    B --\u003e|Cập nhật| D[Chọn địa chỉ \u0026 Nhập thông tin mới];\n    B --\u003e|Xóa (Logic/Ẩn)| E[Chọn địa chỉ \u0026 Xác nhận];\n    B --\u003e|Xem danh sách| F[Hệ thống hiển thị danh sách địa chỉ (có thể lọc)];\n    B --\u003e|Xem chi tiết| G[Chọn địa chỉ \u0026 Hệ thống hiển thị chi tiết];\n    C --\u003e H[Hệ thống kiểm tra dữ liệu (Xã/Phường tồn tại, ...)];\n    D --\u003e H;\n    H --\u003e|Hợp lệ| I[Hệ thống tạo/cập nhật chuỗi địa chỉ đầy đủ \u0026 Lưu thông tin vào CSDL];\n    H --\u003e|Không hợp lệ| J[Thông báo lỗi];\n    I --\u003e K[Thông báo thành công];\n    E --\u003e L[Hệ thống kiểm tra ràng buộc (Địa chỉ đang được sử dụng?)];\n    L --\u003e|Không có ràng buộc nghiêm trọng / Cho phép xóa logic| M[Cập nhật trạng thái địa chỉ (ví dụ: không hoạt động) hoặc xóa nếu không còn tham chiếu];\n    L --\u003e|Có ràng buộc không thể xóa| N[Thông báo lỗi không thể xóa];\n    M --\u003e K;\n    F --\u003e Z[Kết thúc];\n    G --\u003e Z;\n    J --\u003e A;\n    K --\u003e A;\n    N --\u003e A;\n```\n\n### 2.3. Chi Tiết Các Bước Quy Trình\n\n#### 2.3.1. Thêm Mới Địa Chỉ\n- **Mô tả**: Người dùng cung cấp thông tin chi tiết để tạo một địa chỉ mới.\n- **Đầu vào**: Số nhà/đường phố, UUID của xã/phường, mã bưu điện (tùy chọn), kinh độ (tùy chọn), vĩ độ (tùy chọn), ghi chú (tùy chọn), trạng thái (mặc định là hoạt động).\n- **Đầu ra**: Địa chỉ mới được tạo trong hệ thống, bao gồm chuỗi địa chỉ đầy đủ được tự động tạo.\n- **Người thực hiện**: Người dùng có quyền (thường trong ngữ cảnh tạo Khách hàng, NCC, etc.).\n- **Điều kiện tiên quyết**: Người dùng đã đăng nhập. Xã/phường liên kết phải tồn tại.\n- **Xử lý ngoại lệ**:\n    - Nếu xã/phường không tồn tại: Thông báo lỗi.\n    - Nếu thông tin không hợp lệ: Thông báo lỗi.\n    - Hệ thống có thể kiểm tra sự trùng lặp địa chỉ dựa trên các thành phần để gợi ý sử dụng địa chỉ đã có.\n\n#### 2.3.2. Cập Nhật Thông Tin Địa Chỉ\n- **Mô tả**: Người dùng thay đổi thông tin của một địa chỉ đã tồn tại.\n- **Đầu vào**: UUID của địa chỉ cần cập nhật, thông tin mới.\n- **Đầu ra**: Thông tin địa chỉ được cập nhật trong hệ thống.\n- **Người thực hiện**: Người dùng có quyền.\n- **Điều kiện tiên quyết**: Địa chỉ tồn tại trong hệ thống.\n- **Xử lý ngoại lệ**:\n    - Nếu địa chỉ không tồn tại: Thông báo lỗi.\n    - Nếu thông tin không hợp lệ: Thông báo lỗi.\n\n#### 2.3.3. Xóa Địa Chỉ\n- **Mô tả**: Người dùng xóa một địa chỉ khỏi hệ thống. Thường là xóa logic (đánh dấu không hoạt động) nếu địa chỉ đã được sử dụng.\n- **Đầu vào**: UUID của địa chỉ cần xóa.\n- **Đầu ra**: Địa chỉ bị xóa (hoặc đánh dấu không hoạt động).\n- **Người thực hiện**: Người dùng có quyền.\n- **Điều kiện tiên quyết**: Địa chỉ tồn tại trong hệ thống.\n- **Xử lý ngoại lệ**:\n    - Nếu địa chỉ không tồn tại: Thông báo lỗi.\n    - Nếu địa chỉ đang được tham chiếu bởi các đối tượng quan trọng (ví dụ: hóa đơn đã phát hành): Cân nhắc chỉ cho phép xóa logic hoặc không cho xóa.\n\n#### 2.3.4. Xem Danh Sách Địa Chỉ\n- **Mô tả**: Người dùng xem danh sách các địa chỉ (thường trong ngữ cảnh của một đối tượng, ví dụ: địa chỉ của một khách hàng, hoặc tìm kiếm địa chỉ chung).\n- **Đầu vào**: Entity slug, tùy chọn: các tiêu chí lọc (đường phố, xã/phường UUID, quận/huyện UUID, tỉnh/thành UUID, etc.), phân trang.\n- **Đầu ra**: Danh sách các địa chỉ thỏa mãn điều kiện.\n- **Người thực hiện**: Bất kỳ người dùng nào có quyền truy cập chức năng.\n\n#### 2.3.5. Xem Chi Tiết Địa Chỉ\n- **Mô tả**: Người dùng xem thông tin chi tiết của một địa chỉ cụ thể.\n- **Đầu vào**: UUID của địa chỉ.\n- **Đầu ra**: Thông tin chi tiết của địa chỉ, bao gồm các thành phần địa lý liên quan.\n- **Người thực hiện**: Bất kỳ người dùng nào có quyền truy cập chức năng.\n- **Điều kiện tiên quyết**: Địa chỉ tồn tại trong hệ thống.\n- **Xử lý ngoại lệ**: Nếu địa chỉ không tồn tại: Thông báo lỗi.\n\n### 2.4. Sơ Đồ Tuần Tự (Sequence Diagram) - Thêm Mới Địa Chỉ\n\n```mermaid\nsequenceDiagram\n    participant User as Người dùng\n    participant System as Hệ thống (API)\n    participant Service as DiaChiModelService\n    participant Repository as DiaChiRepository\n    participant XaPhuongRepo as XaPhuongRepository\n    participant DB as Cơ sở dữ liệu\n\n    User-\u003e\u003eSystem: POST /api/{entity_slug}/dia-chi/ (data: so_nha_duong_pho, xa_phuong_uuid, ...)\n    System-\u003e\u003eService: create_dia_chi(entity_slug, data)\n    Service-\u003e\u003eService: _get_entity_model(entity_slug)\n    Service--\u003e\u003eService: entity_model\n    Service-\u003e\u003eXaPhuongRepo: get_xa_phuong_by_uuid_for_entity(data['xa_phuong_uuid'], entity_model)\n    XaPhuongRepo-\u003e\u003eDB: SELECT xp.*, qh.*, tt.*, qg.* FROM XaPhuongModel xp JOIN QuanHuyenModel qh ... WHERE xp.uuid = ... AND xp.entity_id = ...\n    DB--\u003e\u003eXaPhuongRepo: xa_phuong_model_with_parents (or null)\n    XaPhuongRepo--\u003e\u003eService: xa_phuong_model_with_parents (or null)\n    alt Xã/Phường không tồn tại hoặc không thuộc Entity\n        Service--\u003e\u003eSystem: Error: \"Ward/Commune not found or invalid\"\n        System--\u003e\u003eUser: Response 400 (Error message)\n    else Xã/Phường tồn tại\n        Service-\u003e\u003eService: validate_dia_chi_data(data)\n        Service--\u003e\u003eService: validated_data\n        Service-\u003e\u003eService: construct_dia_chi_day_du(validated_data, xa_phuong_model_with_parents)\n        Service--\u003e\u003eService: dia_chi_day_du_string\n        Service-\u003e\u003eRepository: create_dia_chi(entity_model, validated_data, xa_phuong_model_with_parents.id, dia_chi_day_du_string)\n        Repository-\u003e\u003eDB: INSERT INTO DiaChiModel (...) VALUES (...)\n        DB--\u003e\u003eRepository: new_dia_chi_object\n        Repository--\u003e\u003eService: new_dia_chi_object\n        Service--\u003e\u003eSystem: new_dia_chi_object_with_details\n        System--\u003e\u003eUser: Response 201 (new_dia_chi_data)\n    end\n```\n\n### 2.5. Luồng Nghiệp Vụ Thay Thế\n- **Tìm kiếm địa chỉ**: Người dùng có thể tìm kiếm địa chỉ theo chuỗi địa chỉ đầy đủ, hoặc theo các thành phần.\n- **Chọn địa chỉ từ danh sách gợi ý**: Khi nhập, hệ thống có thể gợi ý các địa chỉ đã tồn tại để tránh tạo trùng.\n\n## 3. Yêu Cầu Chức Năng\n\n### 3.1. Danh Sách Chức Năng\n\n| STT | Mã chức năng | Tên chức năng | Mô tả | Độ ưu tiên |\n|-----|--------------|---------------|-------|------------|\n| 1   | GEO_006_F01 | Thêm mới địa chỉ | Cho phép tạo một địa chỉ mới với các thông tin chi tiết. | Cao |\n| 2   | GEO_006_F02 | Cập nhật địa chỉ | Cho phép sửa thông tin của một địa chỉ đã có. | Cao |\n| 3   | GEO_006_F03 | Xóa địa chỉ | Cho phép xóa (logic hoặc vật lý) một địa chỉ. | Cao |\n| 4   | GEO_006_F04 | Xem danh sách địa chỉ | Hiển thị danh sách các địa chỉ, hỗ trợ phân trang và lọc. | Cao |\n| 5   | GEO_006_F05 | Xem chi tiết địa chỉ | Hiển thị thông tin chi tiết của một địa chỉ. | Cao |\n| 6   | GEO_006_F06 | Tìm kiếm địa chỉ | Cho phép tìm kiếm địa chỉ dựa trên các thành phần hoặc chuỗi đầy đủ. | Cao |\n| 7   | GEO_006_F07 | Lấy địa chỉ theo UUID | Lấy thông tin địa chỉ cụ thể bằng UUID. | Cao |\n| 8   | GEO_006_F08 | Tự động tạo chuỗi địa chỉ đầy đủ | Hệ thống tự động ghép các thành phần để tạo chuỗi `dia_chi_day_du`. | Cao |\n\n### 3.2. Chi Tiết Chức Năng\n\n#### 3.2.1. GEO_006_F01: Thêm mới địa chỉ\n- **Mô tả**: Chức năng cho phép người dùng tạo mới một địa chỉ.\n- **Đầu vào**:\n    - `entity_slug`: Slug của Entity.\n    - `data`: Đối tượng chứa thông tin địa chỉ:\n        - `so_nha_duong_pho` (bắt buộc): Số nhà, đường phố (string, max 500).\n        - `xa_phuong_uuid` (bắt buộc): UUID của Xã/Phường.\n        - `ma_buu_dien` (tùy chọn): Mã bưu điện (string, max 20).\n        - `kinh_do` (tùy chọn): Kinh độ (Decimal).\n        - `vi_do` (tùy chọn): Vĩ độ (Decimal).\n        - `ghi_chu` (tùy chọn): Ghi chú (text).\n        - `status` (tùy chọn): Trạng thái (integer). Mặc định là 1.\n- **Đầu ra**: Đối tượng DiaChiModel vừa được tạo, bao gồm `dia_chi_day_du` và thông tin cha (quận, tỉnh, quốc gia).\n- **Điều kiện tiên quyết**: `entity_slug` và `xa_phuong_uuid` hợp lệ.\n- **Luồng xử lý chính**:\n  1. Service lấy `EntityModel` và `XaPhuongModel` (kèm theo Quận, Tỉnh, Quốc gia).\n  2. Service validate dữ liệu.\n  3. Service tạo chuỗi `dia_chi_day_du`.\n  4. Service gọi Repository để tạo mới.\n- **Giao diện liên quan**: Form thêm mới địa chỉ (thường là một phần của form khác như Khách hàng, NCC).\n\n#### 3.2.2. GEO_006_F02: Cập nhật địa chỉ\n- **Mô tả**: Cập nhật thông tin địa chỉ.\n- **Đầu vào**:\n    - `entity_slug`: Slug của Entity.\n    - `uuid`: UUID của địa chỉ.\n    - `data`: Thông tin cập nhật.\n- **Đầu ra**: Đối tượng DiaChiModel đã cập nhật.\n- **Giao diện liên quan**: Form cập nhật địa chỉ.\n\n#### 3.2.3. GEO_006_F03: Xóa địa chỉ\n- **Mô tả**: Xóa một địa chỉ.\n- **Đầu vào**: `entity_slug`, `uuid` của địa chỉ.\n- **Đầu ra**: HTTP 204 No Content (nếu xóa vật lý) hoặc đối tượng địa chỉ đã cập nhật trạng thái.\n- **Điều kiện tiên quyết**: Địa chỉ tồn tại. Kiểm tra ràng buộc tham chiếu.\n- **Giao diện liên quan**: Nút xóa.\n\n#### 3.2.4. GEO_006_F04: Xem danh sách địa chỉ\n- **Mô tả**: Lấy danh sách địa chỉ, có phân trang và lọc.\n- **Đầu vào**: `entity_slug`, `page`, `page_size`, các tham số lọc (ví dụ: `xa_phuong_uuid`, `search_term`).\n- **Đầu ra**: Danh sách DiaChiModel.\n- **Giao diện liên quan**: Trang danh sách địa chỉ (nếu có quản lý tập trung) hoặc kết quả tìm kiếm.\n\n#### 3.2.5. GEO_006_F05: Xem chi tiết địa chỉ\n- **Mô tả**: Lấy chi tiết một địa chỉ.\n- **Đầu vào**: `entity_slug`, `uuid` của địa chỉ.\n- **Đầu ra**: Đối tượng DiaChiModel với đầy đủ thông tin.\n- **Giao diện liên quan**: Hiển thị chi tiết địa chỉ.\n\n## 4. Thiết Kế Kỹ Thuật\n\n### 4.1. Kiến Trúc Hệ Thống\nSử dụng Views/APIs, Services (`DiaChiModelService`), Repositories (`DiaChiRepository`), Models (`DiaChiModel`, `XaPhuongModel`, `EntityModel`).\n\n### 4.2. API Endpoints\n\n- **Base URL**: `/api/{entity_slug}/dia-chi/`\n- **Endpoints**:\n    - `GET /`: Lấy danh sách địa chỉ. (GEO_006_F04)\n        - Query params: `page`, `page_size`, `xa_phuong_uuid`, `search` (tìm trong `so_nha_duong_pho`, `dia_chi_day_du`), `status`.\n    - `POST /`: Tạo mới địa chỉ. (GEO_006_F01)\n        - Request body: `{ \"so_nha_duong_pho\": \"123 Đường ABC\", \"xa_phuong_uuid\": \"uuid_cua_xa_phuong\", ... }`\n    - `GET /{uuid}/`: Lấy chi tiết địa chỉ. (GEO_006_F05)\n    - `PUT /{uuid}/`: Cập nhật địa chỉ. (GEO_006_F02)\n    - `PATCH /{uuid}/`: Cập nhật một phần địa chỉ. (GEO_006_F02)\n    - `DELETE /{uuid}/`: Xóa địa chỉ. (GEO_006_F03)\n\n### 4.3. Service Logic (`DiaChiModelService`)\n- Lấy thông tin `XaPhuongModel` và các cấp cha (`QuanHuyen`, `TinhThanh`, `QuocGia`, `KhuVuc`) để xây dựng `dia_chi_day_du`.\n- Kiểm tra sự tồn tại của `XaPhuongModel`.\n- Logic kiểm tra trùng lặp địa chỉ (tùy chọn, có thể phức tạp).\n- Xử lý việc xóa địa chỉ (kiểm tra tham chiếu).\n\n### 4.4. Mô Hình Dữ Liệu\n\n#### 4.4.1. Entity Relationship Diagram (ERD)\n\n```mermaid\nerDiagram\n    ENTITY ||--|{ QUOC_GIA : \"quản lý\"\n    ENTITY ||--|{ KHU_VUC : \"quản lý\"\n    ENTITY ||--|{ TINH_THANH : \"quản lý\"\n    ENTITY ||--|{ QUAN_HUYEN : \"quản lý\"\n    ENTITY ||--|{ XA_PHUONG : \"quản lý\"\n    ENTITY ||--|{ DIA_CHI : \"quản lý\"\n\n    QUOC_GIA ||--o{ KHU_VUC : \"có\"\n    QUOC_GIA ||--o{ TINH_THANH : \"có\"\n    KHU_VUC ||--o{ TINH_THANH : \"nhóm (tùy chọn)\"\n    TINH_THANH ||--o{ QUAN_HUYEN : \"có\"\n    QUAN_HUYEN ||--o{ XA_PHUONG : \"có\"\n    XA_PHUONG ||--o{ DIA_CHI : \"thuộc\"\n\n    KHACH_HANG {\n        uuid uuid PK\n        string ten_kh\n        uuid dia_chi_giao_hang_id FK \"Địa chỉ giao hàng\"\n        uuid dia_chi_thanh_toan_id FK \"Địa chỉ thanh toán\"\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n    KHACH_HANG }o--|| DIA_CHI : \"sử dụng (giao hàng)\"\n    KHACH_HANG }o--|| DIA_CHI : \"sử dụng (thanh toán)\"\n\n    ENTITY {\n        uuid uuid PK\n        string slug\n        string name\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    XA_PHUONG {\n        uuid uuid PK\n        string ma_xa\n        string ten_xa\n        uuid quan_huyen_id FK\n        uuid entity_id FK\n        \u003cem\u003e(các trường khác)\u003c/em\u003e\n    }\n\n    DIA_CHI {\n        uuid uuid PK\n        string so_nha_duong_pho \"Số nhà, đường phố\"\n        string dia_chi_day_du \"Địa chỉ đầy đủ (auto-generated)\"\n        string ma_buu_dien \"Mã bưu điện\"\n        decimal kinh_do \"Kinh độ\"\n        decimal vi_do \"Vĩ độ\"\n        text ghi_chu \"Ghi chú\"\n        integer status \"Trạng thái\"\n        datetime created\n        datetime updated\n        uuid entity_id FK \"Khóa ngoại tới ENTITY\"\n        uuid xa_phuong_id FK \"Khóa ngoại tới XA_PHUONG\"\n    }\n```\n*Lưu ý: Các mối quan hệ từ `KHACH_HANG` (ví dụ) đến `DIA_CHI` chỉ là minh họa. Nhiều bảng khác cũng có thể liên kết đến `DIA_CHI`.*\n\n#### 4.4.2. Chi Tiết Bảng Dữ Liệu\n\n##### Bảng: `DiaChiModel` (django_ledger_diachimodel)\n- **Mô tả**: Lưu trữ thông tin địa chỉ chi tiết.\n- **Các cột chính**:\n    - `uuid` (UUID, Khóa chính).\n    - `so_nha_duong_pho` (CharField, max_length=500).\n    - `dia_chi_day_du` (TextField, null=True, blank=True, editable=False) - Được tạo tự động.\n    - `ma_buu_dien` (CharField, max_length=20, null=True, blank=True).\n    - `kinh_do` (DecimalField, max_digits=12, decimal_places=9, null=True, blank=True).\n    - `vi_do` (DecimalField, max_digits=12, decimal_places=9, null=True, blank=True).\n    - `ghi_chu` (TextField, null=True, blank=True).\n    - `status` (IntegerField, default=1).\n    - `entity_model` (ForeignKey đến `EntityModel`).\n    - `xa_phuong` (ForeignKey đến `XaPhuongModel`).\n    - `created` (DateTimeField, auto_now_add=True).\n    - `updated` (DateTimeField, auto_now=True).\n- **Indexes**:\n    - Index trên (`entity_model`, `xa_phuong`).\n    - Có thể cân nhắc index trên `dia_chi_day_du` nếu thường xuyên tìm kiếm chính xác, hoặc sử dụng Full-Text Search.\n\n## 5. Kế Hoạch Kiểm Thử\n\n### 5.1. Phạm Vi Kiểm Thử\n- CRUD cho Địa Chỉ.\n- Tự động tạo `dia_chi_day_du` từ các thành phần.\n- Validation dữ liệu (bao gồm `xa_phuong_uuid`).\n- Xử lý xóa địa chỉ (kiểm tra tham chiếu).\n- Tìm kiếm địa chỉ.\n\n### 5.2. Kịch Bản Kiểm Thử (Ví dụ)\n\n| STT | Mã kịch bản | Tên kịch bản | Mô tả | Điều kiện tiên quyết | Các bước | Kết quả mong đợi |\n|-----|------------|--------------|-------|---------------------|----------|-----------------|\n| 1   | GEO_006_TC01 | Thêm mới địa chỉ thành công | Kiểm tra thêm địa chỉ với dữ liệu hợp lệ. | User đăng nhập, có quyền. Entity \"E1\", Xã Phường \"PBN\" (uuid_pbn) thuộc Quận \"Q1\", Tỉnh \"HCM\", Quốc gia \"VN\" tồn tại. | 1. POST `/api/E1/dia-chi/`. 2. Payload: `{\"so_nha_duong_pho\": \"Số 1, Đường Đồng Khởi\", \"xa_phuong_uuid\": \"uuid_pbn\"}`. | 1. HTTP 201. 2. Dữ liệu địa chỉ được trả về, `dia_chi_day_du` được tạo đúng (ví dụ: \"Số 1, Đường Đồng Khởi, Phường Bến Nghé, Quận 1, TP. Hồ Chí Minh, Việt Nam\"). 3. Địa chỉ được lưu vào CSDL. |\n| 2   | GEO_006_TC02 | Thêm mới địa chỉ với xã phường không tồn tại | Kiểm tra thêm địa chỉ với `xa_phuong_uuid` không tồn tại. | Như TC01. `invalid_uuid_xp` không tồn tại. | 1. POST `/api/E1/dia-chi/`. 2. Payload: `{\"so_nha_duong_pho\": \"Số 2, Đường Nguyễn Huệ\", \"xa_phuong_uuid\": \"invalid_uuid_xp\"}`. | 1. HTTP 400. 2. Lỗi \"Ward/Commune not found or invalid\". |\n| 3   | GEO_006_TC03 | Cập nhật địa chỉ | Thay đổi số nhà của một địa chỉ. | Địa chỉ \"DC1\" (uuid_dc1) tồn tại. | 1. PATCH `/api/E1/dia-chi/uuid_dc1/`. 2. Payload: `{\"so_nha_duong_pho\": \"Số 1A, Đường Đồng Khởi\"}`. | 1. HTTP 200. 2. `so_nha_duong_pho` và `dia_chi_day_du` được cập nhật. |\n| 4   | GEO_006_TC04 | Xóa địa chỉ đang được sử dụng | Cố gắng xóa địa chỉ \"DC1\" đang được một Khách hàng \"KH1\" sử dụng. | Địa chỉ \"DC1\" được \"KH1\" tham chiếu. | 1. DELETE `/api/E1/dia-chi/uuid_dc1/`. | 1. HTTP 400 (hoặc 200 nếu là xóa logic). 2. Thông báo lỗi \"Address is in use\" hoặc trạng thái địa chỉ được cập nhật thành \"không hoạt động\". |\n\n## 6. Phụ Lục\n\n### 6.1. Danh Sách Tài Liệu Tham Khảo\n- Mã nguồn Django Ledger: `django_ledger/services/dia_chi/dia_chi.py` (dự kiến)\n- Mã nguồn Django Ledger: `django_ledger/repositories/dia_chi/dia_chi.py` (dự kiến)\n- Mã nguồn Django Ledger: `django_ledger/models/dia_chi.py` (dự kiến)\n\n### 6.2. Danh Mục Thuật Ngữ\n(Đã định nghĩa ở mục 1.3)\n\n### 6.3. Lịch Sử Thay Đổi Tài Liệu\n\n| Phiên bản | Ngày | Người thực hiện | Mô tả thay đổi |\n|-----------|------|-----------------|---------------|\n| 1.0 | 13/05/2025 | Cline | Tạo mới tài liệu. |\n"])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/GEO_006_Quan_Ly_Dia_Chi\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/GEO_006_Quan_Ly_Dia_Chi/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/GEO_006_Quan_Ly_Dia_Chi\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"GEO_006_Quan_Ly_Dia_Chi\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/GEO_006_Quan_Ly_Dia_Chi\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>