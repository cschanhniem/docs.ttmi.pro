<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/erp-docs/_next/static/css/4b73dfd0f7bdc629.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js"/><script src="/erp-docs/_next/static/chunks/7384d974-8b753aa07a0575a2.js" async=""></script><script src="/erp-docs/_next/static/chunks/381-1b6d0728bba7b8e7.js" async=""></script><script src="/erp-docs/_next/static/chunks/main-app-5d87a2fd0f4f2f33.js" async=""></script><script src="/erp-docs/_next/static/chunks/d550ec10-485e3f71f5def856.js" async=""></script><script src="/erp-docs/_next/static/chunks/993-1b6a71072be86da4.js" async=""></script><script src="/erp-docs/_next/static/chunks/410-1ece2fcedd156d2f.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js" async=""></script><script src="/erp-docs/_next/static/chunks/app/layout-b6ef60bec0ff2cf2.js" async=""></script><title>undefined | ERP Documentation</title><meta name="keywords" content="documentation,ERP,technical,mermaid,markdown"/><meta name="next-size-adjust"/><script src="/erp-docs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="__className_985585"><div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div><script src="/erp-docs/_next/static/chunks/webpack-39532e8569213db6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/erp-docs/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5214,[],\"\"]\n5:I[3040,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"DocLayout\"]\n6:I[1276,[\"135\",\"static/chunks/d550ec10-485e3f71f5def856.js\",\"993\",\"static/chunks/993-1b6a71072be86da4.js\",\"410\",\"static/chunks/410-1ece2fcedd156d2f.js\",\"877\",\"static/chunks/app/%5B...slug%5D/page-7978846c0e32abf5.js\"],\"MDXContent\"]\n8:I[6472,[],\"\"]\na:I[9190,[],\"\"]\nb:I[4550,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"ThemeProvider\"]\nc:I[8910,[\"185\",\"static/chunks/app/layout-b6ef60bec0ff2cf2.js\"],\"AuthProvider\"]\ne:I[3013,[],\"\"]\n7:T55a3,"])</script><script>self.__next_f.push([1,"# TRN_002_Transportation_Quản Lý Phương Tiện Giao Hàng\n\n*Phiên bản: 1.0*\n*Người tạo: Gemini AI Assistant*\n*Ngày tạo: 2024-07-31*\n*Cập nhật lần cuối: 2024-07-31*\n*Người cập nhật: Gemini AI Assistant*\n\n## 1. Tổng Quan Nghiệp Vụ\n\n### 1.1. Mô Tả Nghiệp Vụ\nNghiệp vụ Quản Lý Phương Tiện Giao Hàng (trong mã nguồn là `PhuongTienGiaoHangModel`, còn được gọi là Delivery Method) cho phép người dùng định nghĩa và quản lý các phương thức giao hàng cho đơn hàng. Các phương thức này có thể bao gồm giao hàng tiêu chuẩn, giao hàng nhanh, nhận tại cửa hàng, v.v. Mỗi phương tiện giao hàng được xác định bởi một mã, tên, trạng thái (hoạt động/không hoạt động) và thuộc về một Đơn vị (Entity) cụ thể trong hệ thống. Mục đích là cung cấp một danh mục chuẩn hóa các phương tiện giao hàng để sử dụng trong các quy trình liên quan đến xử lý đơn hàng và vận chuyển.\n\n### 1.2. Phạm Vi Áp Dụng\n- Áp dụng cho từng Đơn vị (Entity) trong hệ thống.\n- Các bộ phận liên quan đến quản lý đơn hàng, dịch vụ khách hàng, kho vận.\n\n### 1.3. Định Nghĩa Thuật Ngữ\n| Thuật ngữ | Định nghĩa |\n|-----------|------------|\n| Phương Tiện Giao Hàng (PTGH) | Một phương thức giao hàng được định nghĩa trong hệ thống (ví dụ: giao hàng tiêu chuẩn, giao hàng nhanh). Trong mã nguồn là `PhuongTienGiaoHangModel`. |\n| Đơn vị (Entity) | Tổ chức hoặc công ty mà PTGH được định nghĩa và áp dụng. |\n| `ma_ptgh` | Mã định danh duy nhất cho một PTGH trong một đơn vị (tối đa 100 ký tự). |\n| `ten_ptgh` | Tên mô tả chính của PTGH. |\n| `ten_ptgh2` | Tên mô tả phụ/thay thế của PTGH (tùy chọn). |\n| `status` | Trạng thái của PTGH: '1' (Active - Hoạt động), '0' (Inactive - Không hoạt động). |\n| `entity_model` | Đối tượng Đơn vị (Entity) mà PTGH này trực thuộc. |\n| UUID | Định danh duy nhất toàn cục cho mỗi bản ghi PTGH. |\n\n### 1.4. Tài Liệu Liên Quan\n| STT | Mã tài liệu | Tên tài liệu | Mô tả |\n|-----|-------------|--------------|-------|\n| 1   | `django_ledger/models/phuong_tien_giao_hang.py` | Model Định Nghĩa PTGH | Định nghĩa cấu trúc dữ liệu cho `PhuongTienGiaoHangModel`. |\n| 2   | `django_ledger/api/views/phuong_tien_giao_hang.py` | API Endpoints PTGH | Các điểm cuối API để tương tác với nghiệp vụ Quản Lý PTGH. |\n| 3   | `django_ledger/api/serializers/phuong_tien_giao_hang.py` | Serializers PTGH | Định dạng dữ liệu JSON cho API, thực hiện validation. |\n| 4   | `django_ledger/services/phuong_tien_giao_hang/phuong_tien_giao_hang.py` | Service Logic PTGH | Logic nghiệp vụ cho việc tạo, cập nhật, xóa, truy vấn PTGH. |\n| 5   | `django_ledger/repositories/phuong_tien_giao_hang/phuong_tien_giao_hang.py` | Repository PTGH | Lớp truy cập dữ liệu cho PTGH. |\n| 6   | `django_ledger/api/urls.py` | URL Configuration | Đăng ký endpoint `/api/{entity_slug}/delivery-methods/` cho PTGH. |\n| 7   | `django_ledger/models/ban_hang/hoa_don_ban_ra/hoa_don_ban_hang/hoa_don_ban_hang.py` | Hóa Đơn Bán Hàng Model | Sử dụng `PhuongTienGiaoHangModel` làm ForeignKey (`phuong_thuc_giao_hang`). |\n\n## 2. Quy Trình Nghiệp Vụ\n\n### 2.1. Tổng Quan Quy Trình\nNgười dùng có thẩm quyền (ví dụ: quản trị viên, nhân viên bán hàng) tương tác với hệ thống thông qua giao diện người dùng hoặc API để thực hiện các thao tác CRUD (Create, Read, Update, Delete) đối với các Phương Tiện Giao Hàng. Hệ thống sẽ xử lý các yêu cầu này thông qua `PhuongTienGiaoHangModelViewSet`, sử dụng `PhuongTienGiaoHangModelService` để thực thi logic nghiệp vụ và `PhuongTienGiaoHangRepository` để tương tác với cơ sở dữ liệu. Dữ liệu đầu vào sẽ được kiểm tra (validate) bởi `PhuongTienGiaoHangModelSerializer` và `PhuongTienGiaoHangModelService`.\n\n### 2.2. Sơ Đồ Quy Trình (Business Flow)\n\n```mermaid\nflowchart TD\n    A[Người dùng yêu cầu thao tác PTGH] --\u003e B{API Gateway nhận yêu cầu};\n    B --\u003e C[Xác thực \u0026 Ủy quyền (IsAuthenticated)];\n    C --\u003e D[PhuongTienGiaoHangModelViewSet];\n    D --\u003e E[PhuongTienGiaoHangModelService];\n    E --\u003e F[PhuongTienGiaoHangRepository];\n    F --\u003e G[(Cơ sở dữ liệu - Bảng ptgh)];\n    G --\u003e F;\n    F --\u003e E;\n    E --\u003e D;\n    subgraph \"Validation\"\n        direction LR\n        H[Request Data] --\u003e I[PhuongTienGiaoHangModelSerializer];\n        I --\u003e J[PhuongTienGiaoHangModelService.validate_phuong_tien_giao_hang_data];\n    end\n    D --\u003e H;\n    J -- Dữ liệu hợp lệ --\u003e E;\n    J -- Dữ liệu không hợp lệ --\u003e K[Báo lỗi cho ViewSet];\n    K --\u003e B;\n    D --\u003e L[Trả kết quả cho người dùng];\n    B --\u003e L;\n```\n\n### 2.3. Chi Tiết Các Bước Quy Trình\n\n#### 2.3.1. Tạo Mới Phương Tiện Giao Hàng\n- **Mô tả**: Người dùng cung cấp thông tin để tạo một PTGH mới cho một Đơn vị.\n- **Đầu vào**: Dữ liệu PTGH (`ma_ptgh`, `ten_ptgh`, `ten_ptgh2` (tùy chọn), `status` (tùy chọn, mặc định '1')). `entity_slug` được lấy từ URL.\n- **Đầu ra**: PTGH mới được tạo thành công hoặc thông báo lỗi.\n- **Người thực hiện**: Quản trị viên, nhân viên bán hàng.\n- **Điều kiện tiên quyết**: Đăng nhập hệ thống, có quyền truy cập vào Đơn vị. `ma_ptgh` phải là duy nhất trong Đơn vị đó. `ma_ptgh` và `ten_ptgh` là bắt buộc.\n- **Xử lý ngoại lệ**: Dữ liệu không hợp lệ (thiếu trường, sai định dạng, `ma_ptgh` quá dài hoặc trùng), Đơn vị không tồn tại.\n\n#### 2.3.2. Xem/Tìm Kiếm Phương Tiện Giao Hàng\n- **Mô tả**: Người dùng xem danh sách các PTGH của một Đơn vị hoặc chi tiết một PTGH cụ thể. Hỗ trợ lọc theo `status`, `ma_ptgh`, `ten_ptgh` và phân trang.\n- **Đầu vào**: `entity_slug` (từ URL). Tùy chọn: `uuid` của PTGH (để xem chi tiết), `status` (để lọc), `ma_ptgh`, `ten_ptgh`, tham số phân trang (`page`, `page_size`).\n- **Đầu ra**: Danh sách các PTGH hoặc thông tin chi tiết của một PTGH.\n- **Người thực hiện**: Mọi người dùng có quyền xem.\n- **Điều kiện tiên quyết**: Đăng nhập hệ thống.\n- **Xử lý ngoại lệ**: PTGH không tồn tại, Đơn vị không tồn tại.\n\n#### 2.3.3. Cập Nhật Phương Tiện Giao Hàng\n- **Mô tả**: Người dùng thay đổi thông tin của một PTGH đã tồn tại.\n- **Đầu vào**: `entity_slug`, `uuid` của PTGH, và dữ liệu cần cập nhật (`ma_ptgh`, `ten_ptgh`, `ten_ptgh2`, `status`).\n- **Đầu ra**: PTGH được cập nhật thành công hoặc thông báo lỗi.\n- **Người thực hiện**: Quản trị viên, nhân viên bán hàng.\n- **Điều kiện tiên quyết**: Đăng nhập, PTGH phải tồn tại và thuộc Đơn vị chỉ định. Nếu `ma_ptgh` thay đổi, mã mới không được trùng.\n- **Xử lý ngoại lệ**: Dữ liệu không hợp lệ, PTGH không tồn tại, `ma_ptgh` mới bị trùng.\n\n#### 2.3.4. Xóa Phương Tiện Giao Hàng\n- **Mô tả**: Người dùng xóa một PTGH khỏi hệ thống.\n- **Đầu vào**: `entity_slug`, `uuid` của PTGH.\n- **Đầu ra**: Thông báo xóa thành công (HTTP 204) hoặc lỗi.\n- **Người thực hiện**: Quản trị viên, nhân viên bán hàng.\n- **Điều kiện tiên quyết**: Đăng nhập, PTGH phải tồn tại và thuộc Đơn vị chỉ định. (Cần xem xét ràng buộc nếu PTGH đang được sử dụng).\n- **Xử lý ngoại lệ**: PTGH không tồn tại.\n\n### 2.4. Sơ Đồ Tuần Tự (Sequence Diagram) - Tạo mới Phương Tiện Giao Hàng\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant APIView as PhuongTienGiaoHangModelViewSet\n    participant Service as PhuongTienGiaoHangModelService\n    participant Serializer as PhuongTienGiaoHangModelSerializer\n    participant Repository as PhuongTienGiaoHangRepository\n    participant Model as PhuongTienGiaoHangModel\n    participant DB as Database\n\n    User-\u003e\u003eAPIView: POST /api/{entity_slug}/delivery-methods/ (data)\n    APIView-\u003e\u003eService: get_service()\n    Service--\u003e\u003eAPIView: service_instance\n    APIView-\u003e\u003eService: create_phuong_tien_giao_hang(entity_slug, data)\n    Service-\u003e\u003eService: _get_entity_model(entity_slug)\n    Service--\u003e\u003eService: entity_model\n    Service-\u003e\u003eService: validate_phuong_tien_giao_hang_data(data)\n    alt Dữ liệu không hợp lệ (Service validation)\n        Service--\u003e\u003eAPIView: Raise ValueError\n        APIView--\u003e\u003eUser: HTTP 400 (Error details)\n    else Dữ liệu hợp lệ\n        Service--\u003e\u003eService: validated_data\n        Service-\u003e\u003eRepository: create_phuong_tien_giao_hang(validated_data, entity_model)\n        Repository-\u003e\u003eModel: objects.create(entity_model=entity_model, **validated_data)\n        Model-\u003e\u003eDB: INSERT INTO ptgh\n        DB--\u003e\u003eModel: created_ptgh_instance\n        Model--\u003e\u003eRepository: created_ptgh_instance\n        Repository--\u003e\u003eService: created_ptgh_instance\n        Service--\u003e\u003eAPIView: created_ptgh_instance\n        APIView-\u003e\u003eSerializer: get_serializer(created_ptgh_instance)\n        Serializer--\u003e\u003eAPIView: serialized_data\n        APIView--\u003e\u003eUser: HTTP 201 (serialized_data)\n    end\n```\n\n### 2.5. Luồng Nghiệp Vụ Thay Thế\n- **Validation ở Serializer**: `PhuongTienGiaoHangModelSerializer` cũng thực hiện validation cho `ma_ptgh` (không trống, không quá 100 ký tự) và `ten_ptgh` (không trống). Nếu validation này thất bại ở ViewSet trước khi gọi Service, lỗi cũng sẽ được trả về.\n- **Kiểm tra quyền**: `EntityRelatedViewSet` và `PhuongTienGiaoHangModelQueryset.for_entity` đảm bảo người dùng chỉ có thể thao tác trên các PTGH thuộc các Đơn vị mà họ có quyền truy cập.\n\n## 3. Yêu Cầu Chức Năng\n\n### 3.1. Danh Sách Chức Năng\n\n| STT | Mã chức năng | Tên chức năng | Mô tả | Độ ưu tiên |\n|-----|--------------|---------------|-------|------------|\n| 1   | TRN002-PTGH-LIST | Xem danh sách PTGH | Lấy danh sách PTGH theo Đơn vị, hỗ trợ lọc theo `status`, `ma_ptgh`, `ten_ptgh`, phân trang. | Cao |\n| 2   | TRN002-PTGH-CREATE | Tạo mới PTGH | Tạo một PTGH mới cho một Đơn vị. | Cao |\n| 3   | TRN002-PTGH-RETRIEVE | Xem chi tiết PTGH | Lấy thông tin chi tiết của một PTGH bằng UUID. | Cao |\n| 4   | TRN002-PTGH-UPDATE | Cập nhật PTGH | Cập nhật thông tin của một PTGH đã có (PUT). | Cao |\n| 5   | TRN002-PTGH-PARTIAL-UPDATE | Cập nhật một phần PTGH | Cập nhật một phần thông tin của một PTGH đã có (PATCH). | Cao |\n| 6   | TRN002-PTGH-DELETE | Xóa PTGH | Xóa một PTGH. | Cao |\n\n### 3.2. Chi Tiết Chức Năng\n\n#### 3.2.1. TRN002-PTGH-CREATE: Tạo mới Phương Tiện Giao Hàng\n- **Mô tả**: Cho phép tạo một PTGH mới.\n- **Đầu vào**: `entity_slug` (trong URL). Dữ liệu JSON body: `ma_ptgh` (string, bắt buộc, max 100), `ten_ptgh` (string, bắt buộc), `ten_ptgh2` (string, tùy chọn), `status` (string '0' hoặc '1', tùy chọn, default '1').\n- **Đầu ra**: Dữ liệu JSON của PTGH vừa tạo.\n- **Điều kiện tiên quyết**: `ma_ptgh`, `ten_ptgh` phải được cung cấp. `ma_ptgh` phải là duy nhất cho `entity_model`.\n- **Luồng xử lý chính**:\n  1. `PhuongTienGiaoHangModelViewSet.create()` nhận request.\n  2. Lấy `service` instance.\n  3. Gọi `service.create_phuong_tien_giao_hang(entity_slug, request.data)`.\n     a. Service lấy `entity_model` từ `entity_slug`.\n     b. Service gọi `validate_phuong_tien_giao_hang_data()`: kiểm tra `ma_ptgh`, `ten_ptgh` bắt buộc, `ma_ptgh` không quá 100 ký tự, `status` hợp lệ.\n     c. Service gọi `repository.create_phuong_tien_giao_hang()` với `validated_data` và `entity_model`.\n     d. Repository tạo bản ghi `PhuongTienGiaoHangModel` trong DB.\n  4. Serialize instance mới tạo và trả về HTTP 201.\n- **Luồng xử lý thay thế/ngoại lệ**:\n  - Validation thất bại (Serializer hoặc Service): Trả về HTTP 400 với chi tiết lỗi.\n  - `entity_slug` không hợp lệ: `_get_entity_model` trong service sẽ raise Http404 (hoặc tương đương).\n  - `unique_together` (`entity_model`, `ma_ptgh`) bị vi phạm ở DB: Django sẽ raise IntegrityError, cần được bắt và xử lý phù hợp (thường DRF xử lý và trả 400).\n- **Giao diện liên quan**: Form tạo mới PTGH.\n\n*(Các chức năng LIST, RETRIEVE, UPDATE, PARTIAL_UPDATE, DELETE được cung cấp bởi `PhuongTienGiaoHangModelViewSet` kế thừa từ `EntityRelatedViewSet`, sử dụng service và repository tương ứng. `list` có thêm logic lọc theo `status`, `ma_ptgh`, `ten_ptgh`.)*\n\n## 4. Thiết Kế Kỹ Thuật\n\n### 4.1. Kiến Trúc Hệ Thống\nNghiệp vụ này tuân theo kiến trúc 3 lớp với sự hỗ trợ của Repository pattern:\n- **View (API Layer)**: `PhuongTienGiaoHangModelViewSet` xử lý HTTP request/response, xác thực, phân trang, và gọi các services.\n- **Service Layer**: `PhuongTienGiaoHangModelService` chứa logic nghiệp vụ chính, điều phối hoạt động giữa View và Repository, thực hiện validation nghiệp vụ.\n- **Repository Layer**: `PhuongTienGiaoHangRepository` chịu trách nhiệm tương tác trực tiếp với cơ sở dữ liệu thông qua Django ORM (`PhuongTienGiaoHangModel`).\n- **Model Layer**: `PhuongTienGiaoHangModel` định nghĩa cấu trúc dữ liệu, bao gồm các trường, ràng buộc và custom manager/queryset.\n\n```mermaid\ngraph TD\n    Client --\u003e Nginx --\u003e Gunicorn\n    Gunicorn --\u003e DjangoApp[Django Application]\n\n    subgraph DjangoApp\n        APILayer[API Layer: PhuongTienGiaoHangModelViewSet]\n        ServiceLayer[Service Layer: PhuongTienGiaoHangModelService]\n        RepositoryLayer[Repository Layer: PhuongTienGiaoHangRepository]\n        ModelLayer[Model Layer: PhuongTienGiaoHangModel]\n        Database[(PostgreSQL Database - ptgh table)]\n\n        APILayer --\u003e|calls| ServiceLayer\n        ServiceLayer --\u003e|uses| RepositoryLayer\n        RepositoryLayer --\u003e|accesses| ModelLayer\n        ModelLayer --\u003e|maps to| Database\n    end\n```\n\n### 4.2. API Endpoints\n\n#### 4.2.1. Phương Tiện Giao Hàng (`PhuongTienGiaoHangModel`)\n- **Mô tả**: Quản lý các phương tiện giao hàng.\n- **Base URL**: `/api/{entity_slug}/delivery-methods/`\n- **Endpoints**:\n  - `GET /`: Lấy danh sách PTGH (hỗ trợ lọc theo `status`, `ma_ptgh`, `ten_ptgh`, phân trang `ERPPagination`).\n    - Query params: `status` (0 hoặc 1), `ma_ptgh` (string), `ten_ptgh` (string), `page`, `page_size`.\n  - `POST /`: Tạo một PTGH mới.\n  - `GET /{uuid}/`: Lấy chi tiết một PTGH.\n  - `PUT /{uuid}/`: Cập nhật toàn bộ một PTGH.\n  - `PATCH /{uuid}/`: Cập nhật một phần một PTGH.\n  - `DELETE /{uuid}/`: Xóa một PTGH.\n\n### 4.3. Service Logic (`PhuongTienGiaoHangModelService`)\n- **Mô tả**: Cung cấp logic nghiệp vụ cho `PhuongTienGiaoHangModel`.\n- **Chức năng chính**:\n  1. `_get_entity_model(entity_slug)`: Lấy `EntityModel` từ slug.\n  2. `validate_phuong_tien_giao_hang_data(data)`: Kiểm tra các trường bắt buộc (`ma_ptgh`, `ten_ptgh`), độ dài `ma_ptgh`, giá trị `status`.\n  3. `get_all_phuong_tien_giao_hang(entity_slug, user_model, page, page_size)`: Lấy tất cả PTGH cho entity, có phân trang.\n  4. `get_phuong_tien_giao_hang(entity_slug, uuid)`: Lấy PTGH cụ thể, kiểm tra có thuộc entity không.\n  5. `create_phuong_tien_giao_hang(entity_slug, data)`:\n     - Lấy `entity_model`.\n     - Validate dữ liệu.\n     - Gọi `repository.create_phuong_tien_giao_hang()`.\n  6. `update_phuong_tien_giao_hang(entity_slug, uuid, data)`:\n     - Lấy `entity_model`.\n     - Validate dữ liệu.\n     - Kiểm tra PTGH tồn tại và thuộc entity.\n     - Gọi `repository.update_phuong_tien_giao_hang()`.\n  7. `delete_phuong_tien_giao_hang(entity_slug, uuid)`:\n     - Kiểm tra PTGH tồn tại và thuộc entity.\n     - Gọi `repository.delete_phuong_tien_giao_hang()`.\n- **Các dependencies**: `PhuongTienGiaoHangRepository`, `EntityModel`.\n\n### 4.4. Mô Hình Dữ Liệu\n\n#### 4.4.1. Entity Relationship Diagram (ERD)\n\n```mermaid\nerDiagram\n    EntityModel ||--o{ PhuongTienGiaoHangModel : \"has\"\n    PhuongTienGiaoHangModel }o--|| HoaDonBanHangModel : \"can be used in (as phuong_thuc_giao_hang)\"\n\n    EntityModel {\n        UUID uuid PK\n        string slug\n        string name\n        # ... other fields\n    }\n\n    PhuongTienGiaoHangModel {\n        UUID uuid PK\n        UUID entity_model_id FK\n        string ma_ptgh \"Mã PTGH (unique per entity, max 100)\"\n        string ten_ptgh \"Tên PTGH\"\n        string ten_ptgh2 \"Tên PTGH (phụ)\"\n        string status \"Trạng thái ('1' Active, '0' Inactive)\"\n        datetime created\n        datetime updated\n    }\n\n    HoaDonBanHangModel {\n        UUID uuid PK\n        # ... other fields\n        UUID phuong_thuc_giao_hang_id FK \"FK to PhuongTienGiaoHangModel\"\n    }\n```\n\n#### 4.4.2. Chi Tiết Bảng Dữ Liệu\n\n##### Bảng: `ptgh` (mapped from `PhuongTienGiaoHangModel`)\n- **Mô tả**: Lưu trữ thông tin các phương tiện giao hàng.\n- **Các cột chính**:\n  - `uuid` (PK, UUIDField): Định danh duy nhất.\n  - `entity_model_id` (FK, UUIDField): Liên kết đến bảng `entity`.\n  - `ma_ptgh` (CharField(100)): Mã phương tiện giao hàng, duy nhất trong phạm vi `entity_model`.\n  - `ten_ptgh` (CharField(255)): Tên phương tiện giao hàng.\n  - `ten_ptgh2` (CharField(255), nullable): Tên thay thế.\n  - `status` (CharField(10), default '1'): Trạng thái ('1' = Active, '0' = Inactive).\n  - `created` (DateTimeField): Thời điểm tạo.\n  - `updated` (DateTimeField): Thời điểm cập nhật cuối.\n- **Indexes**: (`entity_model`, `ma_ptgh`), (`ma_ptgh`), (`status`).\n- **Unique Together**: (`entity_model`, `ma_ptgh`).\n\n## 5. Kế Hoạch Kiểm Thử\n\n### 5.1. Phạm Vi Kiểm Thử\n- Kiểm thử các chức năng CRUD cho PTGH qua API endpoints.\n- Kiểm thử validation dữ liệu đầu vào (trường bắt buộc, độ dài, giá trị hợp lệ, tính duy nhất của `ma_ptgh`).\n- Kiểm thử logic phân quyền (người dùng chỉ thao tác được PTGH của Entity mình có quyền).\n- Kiểm thử API endpoints (status codes, response format, pagination, filtering theo `status`, `ma_ptgh`, `ten_ptgh`).\n- Kiểm thử ràng buộc khi PTGH được sử dụng (ví dụ: trong Hóa đơn bán hàng - nếu có).\n\n### 5.2. Kịch Bản Kiểm Thử\n| STT | Mã kịch bản | Tên kịch bản | Mô tả | Điều kiện tiên quyết | Các bước | Kết quả mong đợi |\n|-----|------------|--------------|-------|---------------------|----------|-----------------|\n| 1   | TC_TRN002_001 | Tạo PTGH thành công | Kiểm tra tạo mới PTGH với dữ liệu hợp lệ. | User đăng nhập, có quyền. `entity_slug` hợp lệ. | 1. Gửi POST request tới `/api/{entity_slug}/delivery-methods/` với data (`ma_ptgh`, `ten_ptgh`) hợp lệ. | 1. Response status 201. 2. Response body chứa thông tin PTGH đã tạo. 3. Dữ liệu được lưu đúng trong DB. |\n| 2   | TC_TRN002_002 | Tạo PTGH thất bại - `ma_ptgh` trùng | Kiểm tra không cho tạo PTGH nếu `ma_ptgh` đã tồn tại cho entity. | User đăng nhập. `ma_ptgh` đã tồn tại cho entity. | 1. Gửi POST request với `ma_ptgh` đã có. | 1. Response status 400. 2. Thông báo lỗi về `ma_ptgh` bị trùng hoặc lỗi validation từ service/serializer. |\n| 3   | TC_TRN002_003 | Tạo PTGH thất bại - thiếu `ten_ptgh` | Kiểm tra lỗi khi thiếu trường `ten_ptgh`. | User đăng nhập. | 1. Gửi POST request chỉ có `ma_ptgh`. | 1. Response status 400. 2. Thông báo lỗi trường `ten_ptgh` là bắt buộc. |\n| 4   | TC_TRN002_004 | Lấy danh sách PTGH | Kiểm tra lấy danh sách PTGH, có phân trang và lọc theo `status`, `ma_ptgh`. | Có sẵn vài PTGH với status và mã khác nhau. | 1. Gửi GET request tới `/api/{entity_slug}/delivery-methods/?page=1\u0026page_size=2\u0026status=1\u0026ma_ptgh=EXPRESS`. | 1. Response status 200. 2. Response body chứa danh sách PTGH (tối đa 2), status='1', `ma_ptgh` chứa 'EXPRESS', thông tin phân trang. |\n| 5   | TC_TRN002_005 | Cập nhật PTGH | Kiểm tra cập nhật thông tin PTGH. | PTGH tồn tại. | 1. Gửi PUT request tới `/api/{entity_slug}/delivery-methods/{uuid}/` với data mới. | 1. Response status 200. 2. Dữ liệu PTGH được cập nhật trong DB. |\n| 6   | TC_TRN002_006 | Xóa PTGH | Kiểm tra xóa PTGH. | PTGH tồn tại. | 1. Gửi DELETE request tới `/api/{entity_slug}/delivery-methods/{uuid}/`. | 1. Response status 204. 2. PTGH bị xóa khỏi DB. |\n\n## 6. Phụ Lục\n\n### 6.1. Danh Sách Tài Liệu Tham Khảo\n- Mã nguồn dự án ERP-BE (các file đã liệt kê ở mục 1.4).\n- Tài liệu Django REST framework.\n- Tài liệu drf-spectacular (nếu dùng cho schema generation).\n\n### 6.2. Danh Mục Thuật Ngữ\n(Xem mục 1.3)\n\n### 6.3. Lịch Sử Thay Đổi Tài Liệu\n| Phiên bản | Ngày       | Người thực hiện      | Mô tả thay đổi                         |\n|-----------|------------|----------------------|----------------------------------------|\n| 1.0       | 2024-07-31 | Gemini AI Assistant  | Tạo tài liệu ban đầu dựa trên source code. |\n\n\n\u003c/rewritten_file\u003e"])</script><script>self.__next_f.push([1,"9:[\"slug\",\"erp/TRN_002_Quan_Ly_Phuong_Tien_Giao_Hang\",\"c\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/erp-docs/_next/static/css/4b73dfd0f7bdc629.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"X5KF-BjlTdL2YCafX7ACW\",\"assetPrefix\":\"/erp-docs\",\"initialCanonicalUrl\":\"/erp/TRN_002_Quan_Ly_Phuong_Tien_Giao_Hang/\",\"initialTree\":[\"\",{\"children\":[[\"slug\",\"erp/TRN_002_Quan_Ly_Phuong_Tien_Giao_Hang\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"erp\\\",\\\"TRN_002_Quan_Ly_Phuong_Tien_Giao_Hang\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[[\"slug\",\"erp/TRN_002_Quan_Ly_Phuong_Tien_Giao_Hang\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",[\"$\",\"$L5\",null,{\"children\":[\"$\",\"article\",null,{\"className\":\"prose prose-slate dark:prose-invert max-w-none\",\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"$undefined\"}],\"$undefined\",\"$undefined\"]}],[\"$\",\"$L6\",null,{\"content\":\"$7\"}]]}]}]],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"__className_985585\",\"children\":[\"$\",\"$Lb\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lc\",null,{\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"undefined | ERP Documentation\"}],[\"$\",\"meta\",\"3\",{\"name\":\"keywords\",\"content\":\"documentation,ERP,technical,mermaid,markdown\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\n4:null\n"])</script></body></html>